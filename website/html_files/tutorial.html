{% extends "base.html" %}

{% block title %}Tutorial{% endblock %}

{% block extra_css %}
<style>
    .tutorial-container {
        max-width: 900px;
        margin: 40px auto;
        background: white;
        padding: 40px;
        border-radius: 8px;
        box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    }
    .tutorial-container.wide {
        max-width: 1400px;
    }
    .tutorial-page {
        display: none;
    }
    .tutorial-page.active {
        display: block;
    }
    .tutorial-page h2 {
        margin-bottom: 20px;
        color: #333;
    }
    .tutorial-page p {
        margin-bottom: 15px;
        line-height: 1.8;
    }
    .form-group {
        margin-bottom: 20px;
    }
    .form-group label {
        display: block;
        margin-bottom: 8px;
        font-weight: 600;
    }
    .form-group input, .form-group select, .form-group textarea {
        width: 100%;
        padding: 10px;
        border: 1px solid #ddd;
        border-radius: 4px;
        font-size: 14px;
    }
    .form-group textarea {
        resize: vertical;
        min-height: 100px;
    }
    .navigation {
        display: flex;
        justify-content: space-between;
        margin-top: 30px;
        padding-top: 20px;
        border-top: 1px solid #eee;
    }
    .page-indicator {
        text-align: center;
        margin-bottom: 20px;
        color: #666;
    }
    
    /* Three Panel Layout */
    .mock-three-panel {
        display: flex;
        gap: 15px;
        margin-top: 20px;
        min-height: 500px;
    }
    .mock-panel {
        flex: 1;
        background: white;
        border-radius: 8px;
        box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        display: flex;
        flex-direction: column;
        overflow: hidden;
    }
    .mock-panel-header {
        padding: 12px 15px;
        background: #007bff;
        color: white;
        font-weight: 600;
        font-size: 14px;
        display: flex;
        justify-content: space-between;
        align-items: center;
    }
    .mock-panel-content {
        flex: 1;
        padding: 15px;
        overflow-y: auto;
        background: #f8f9fa;
    }
    .mock-panel-content.white-bg {
        background: white;
    }
    
    /* Mock Buttons */
    .mock-buttons {
        display: flex;
        gap: 8px;
    }
    .mock-btn {
        padding: 4px 10px;
        background: rgba(255, 255, 255, 0.2);
        color: white;
        border: 1px solid rgba(255, 255, 255, 0.3);
        border-radius: 4px;
        cursor: pointer;
        font-size: 11px;
        transition: background 0.3s;
    }
    .mock-btn:hover {
        background: rgba(255, 255, 255, 0.3);
    }
    
    /* NFR Items */
    .mock-nfr-item {
        margin-bottom: 12px;
        padding: 12px;
        background: white;
        border-radius: 4px;
        border-left: 4px solid #007bff;
    }
    .mock-nfr-item h4 {
        margin-bottom: 6px;
        color: #333;
        font-size: 13px;
        font-weight: 600;
    }
    .mock-nfr-item p {
        margin: 0 0 8px 0;
        color: #666;
        font-size: 12px;
        line-height: 1.4;
    }
    .mock-checkbox-label {
        font-size: 12px;
        display: flex;
        align-items: center;
        gap: 6px;
        cursor: pointer;
        font-weight: normal;
    }
    .mock-checkbox-label input {
        width: auto;
    }
    
    /* Gate Card */
    .mock-gate-card {
        background: #fff;
        border: 1px solid #cfe2ff;
        border-left: 4px solid #0d6efd;
        border-radius: 8px;
        padding: 12px;
        margin-top: 15px;
    }
    .mock-gate-title {
        font-weight: 700;
        margin-bottom: 6px;
        font-size: 13px;
        color: #0b2e4c;
    }
    .mock-gate-nfr {
        background: #f1f7ff;
        border: 1px solid #cfe2ff;
        border-radius: 6px;
        padding: 10px;
        font-size: 12px;
        line-height: 1.4;
        margin-bottom: 10px;
    }
    .mock-gate-textarea {
        width: 100%;
        min-height: 60px;
        border: 1px solid #cfe2ff;
        border-radius: 6px;
        padding: 8px 10px;
        font-size: 12px;
        font-family: inherit;
        resize: vertical;
    }
    
    /* Chat Messages */
    .mock-chat-messages {
        flex: 1;
        padding: 15px;
        overflow-y: auto;
        background: #f8f9fa;
    }
    .mock-message {
        margin-bottom: 12px;
    }
    .mock-message.user {
        text-align: right;
    }
    .mock-message.bot {
        text-align: left;
    }
    .mock-message-content {
        display: inline-block;
        padding: 8px 12px;
        border-radius: 12px;
        max-width: 85%;
        font-size: 12px;
        line-height: 1.4;
    }
    .mock-message.user .mock-message-content {
        background: #007bff;
        color: white;
        text-align: left;
    }
    .mock-message.bot .mock-message-content {
        background: white;
        color: #333;
        border: 1px solid #ddd;
    }
    .mock-chat-input {
        padding: 10px;
        border-top: 1px solid #ddd;
        display: flex;
        gap: 8px;
        background: white;
    }
    .mock-chat-input input {
        flex: 1;
        padding: 8px;
        border: 1px solid #ddd;
        border-radius: 4px;
        font-size: 12px;
    }
    .mock-chat-input button {
        padding: 8px 15px;
        font-size: 12px;
    }
    
    /* Feedback Form */
    .mock-form-section {
        margin-bottom: 15px;
        padding: 12px;
        background: #f8f9fa;
        border-radius: 4px;
        border: 1px solid #ddd;
    }
    .mock-form-section h4 {
        margin-bottom: 10px;
        color: #333;
        font-size: 12px;
    }
    .mock-form-group {
        margin-bottom: 10px;
    }
    .mock-form-group label {
        display: block;
        margin-bottom: 5px;
        font-weight: 600;
        font-size: 11px;
    }
    .mock-radio-group {
        display: flex;
        gap: 8px;
        flex-wrap: wrap;
    }
    .mock-radio-group label {
        display: flex;
        align-items: center;
        font-weight: normal;
        cursor: pointer;
        font-size: 11px;
    }
    .mock-radio-group input[type="radio"] {
        margin-right: 4px;
        width: auto;
    }
    
    /* Step Indicators */
    .step-indicator {
        display: inline-block;
        background: #007bff;
        color: white;
        padding: 4px 12px;
        border-radius: 20px;
        font-size: 12px;
        font-weight: 600;
        margin-bottom: 15px;
    }
    .info-box {
        background: #e7f3ff;
        border: 1px solid #b6d4fe;
        border-radius: 8px;
        padding: 15px;
        margin-bottom: 20px;
    }
    .info-box p {
        margin: 0;
        color: #0a58ca;
        font-size: 14px;
    }
    
    /* Highlight Callout - Floating overlay below buttons */
    .highlight-callout {
        position: absolute;
        top: 45px;
        right: 15px;
        display: flex;
        flex-direction: column;
        align-items: center;
        z-index: 100;
    }
    .highlight-arrow-up {
        font-size: 32px;
        color: #ff8c00;
        font-weight: bold;
        line-height: 1;
        animation: pulse-arrow-up 1s ease-in-out infinite;
    }
    @keyframes pulse-arrow-up {
        0%, 100% { transform: translateY(0); }
        50% { transform: translateY(-5px); }
    }
    .highlight-text-below {
        background: #ff8c00;
        border-radius: 6px;
        padding: 12px 20px;
        color: white;
        font-weight: 600;
        font-size: 14px;
        max-width: 280px;
        text-align: center;
        box-shadow: 0 4px 12px rgba(0,0,0,0.3);
    }
    
    /* Highlight callout for Copy NFRs button */
    .highlight-callout-copy {
        position: absolute;
        top: 35px;
        right: 0;
        display: flex;
        flex-direction: column;
        align-items: flex-end;
        z-index: 100;
    }
    .highlight-callout-copy .highlight-arrow-up {
        margin-right: 45px;
    }
    .highlight-callout-copy .highlight-text-below {
        max-width: 200px;
    }
    
    /* Allow overflow for callouts */
    #page7 .mock-panel {
        overflow: visible !important;
    }
    #page7 .mock-panel-content {
        overflow: visible !important;
    }
    #page7 .mock-batch-info {
        overflow: visible !important;
    }
    #page7 .mock-three-panel {
        overflow: visible !important;
    }
    
    /* Red box around buttons */
    .highlight-buttons-box {
        border: 3px solid #dc3545 !important;
        border-radius: 6px;
        padding: 4px !important;
        background: rgba(220, 53, 69, 0.1);
        animation: pulse-border 1.5s ease-in-out infinite;
    }
    @keyframes pulse-border {
        0%, 100% { box-shadow: 0 0 0 0 rgba(220, 53, 69, 0.4); }
        50% { box-shadow: 0 0 0 6px rgba(220, 53, 69, 0); }
    }
    .practice-label {
        display: inline-block;
        background: #198754;
        color: white;
        padding: 3px 10px;
        border-radius: 4px;
        font-size: 11px;
        font-weight: 600;
        margin-bottom: 10px;
    }
    .validation-error {
        color: #dc3545;
        font-size: 13px;
        margin-top: 8px;
        display: none;
    }
    
    /* Batch Info */
    .mock-batch-info {
        padding: 8px 12px;
        background: #e9ecef;
        border-radius: 4px;
        margin-bottom: 12px;
        font-weight: 600;
        font-size: 12px;
        display: flex;
        justify-content: space-between;
        align-items: center;
    }
    
    /* Panel Step Info */
    .mock-panel-step {
        background: #f1f7ff;
        border: 1px solid #cfe2ff;
        border-left: 4px solid #007bff;
        border-radius: 6px;
        padding: 10px;
        margin-bottom: 12px;
        font-size: 12px;
        color: #0b2e4c;
        line-height: 1.4;
    }
    .mock-panel-step strong {
        font-weight: 700;
    }
</style>
{% endblock %}

{% block content %}
<div class="container">
    <div class="tutorial-container">
        <div class="page-indicator">
            <span id="pageNum">1</span> / <span id="totalPages">5</span>
        </div>
        
        <!-- Page 1: Overview -->
        <div class="tutorial-page active" id="page1">
            <h2>Overview</h2>
            <p style="line-height: 1.8; margin-bottom: 20px;">
                This tool facilitates the evaluation of Non-Functional Requirements (NFRs) from HIPAA through interactive dialogue with a chatbot. You will work through batches of NFRs, engage with the chatbot to obtain assessments, and provide feedback on the chatbot's evaluations.
            </p>
            <p style="line-height: 1.8; margin-bottom: 20px;">
                <strong>You can reopen this tutorial at any time during the evaluation if you need a refresher.</strong>
            </p>
        </div>
        
        <!-- Page 2: What are NFRs? -->
        <div class="tutorial-page" id="page2">
            <h2>What are Non-Functional Requirements (NFRs)?</h2>
            <p style="line-height: 1.8; margin-bottom: 20px;">
                Non-Functional Requirements (NFRs) specify <strong>how</strong> a system should perform rather than <strong>what</strong> it should do. While functional requirements define specific behaviors or functions (for example, "User can reset password"), NFRs establish quality attributes and constraints such as security, performance, reliability, usability, and compliance (for example, "System must reset password within 3 seconds.").
            </p>
            
            <h3 style="margin-top: 30px; margin-bottom: 15px; color: #333;">Examples of NFRs:</h3>
            <ul style="margin-left: 20px; line-height: 2; margin-bottom: 20px;">
                <li><strong>Security:</strong> "Users should be able to change their password that meets security requirements."</li>
                <li><strong>Performance:</strong> "The system must load patient records within 2 seconds."</li>
                <li><strong>Usability:</strong> "The interface must be accessible to users with visual impairments."</li>
                <li><strong>Reliability:</strong> "The system must have 99.9% uptime."</li>
                <li><strong>Compliance:</strong> "All patient data must be encrypted according to HIPAA standards."</li>
            </ul>
        </div>
        
        <!-- Page 3: What is HIPAA? -->
        <div class="tutorial-page" id="page3">
            <h2>What is HIPAA?</h2>
            <p style="line-height: 1.8; margin-bottom: 20px;">
                HIPAA (Health Insurance Portability and Accountability Act) is a U.S. federal law that establishes privacy and security standards for the protection of sensitive patient health information. It requires healthcare providers, insurers, and their business associates to implement safeguards to ensure that Protected Health Information (PHI) remains confidential, secure, and accessible only to authorized individuals.
            </p>
        </div>
        
        <!-- Page 4: Download Code -->
        <div class="tutorial-page" id="page4">
            <h2>Download the Code</h2>
            <p style="line-height: 1.8; margin-bottom: 20px;">
                You will be evaluating NFRs against the <strong>iTrust</strong> codebase, an Electronic Health Record (EHR) system designed to comply with HIPAA standards.
            </p>
            <p><strong>Instructions:</strong></p>
            <ol style="margin-left: 20px; line-height: 2; margin-bottom: 30px;">
                <li>Click the button below to download the code package</li>
                <li>Extract the files to a location on your computer</li>
                <li>Open the project in your preferred code editor (VS Code, IntelliJ, etc.)</li>
            </ol>
            <div style="margin-top: 30px; text-align: center;">
                <a href="/static/iTrust.zip" download="iTrust.zip" class="btn" style="display: inline-block; text-decoration: none;">
                    ðŸ“¦ Download iTrust.zip
                </a>
            </div>
        </div>
        
        <!-- Page 5: Verification -->
        <div class="tutorial-page" id="page5">
            <h2>Verification Entry</h2>
            <p style="line-height: 1.8; margin-bottom: 15px;">
                Before beginning the experiment, please confirm you have successfully downloaded and extracted the code.
            </p>
            <p style="line-height: 1.8; margin-bottom: 20px;">
                In the downloaded folder, open the file named <strong>"verification.txt"</strong>
            </p>
            
            <div class="form-group">
                <label for="password">What is the verification password written in this "verification.txt"?</label>
                <input type="text" id="password" placeholder="Enter password">
            </div>
            
            <div id="passwordError" style="color: red; margin-top: 10px; display: none;">
                Incorrect password. Please try again.
            </div>
        </div>
        
        <!-- Page 6: Interactive Practice - Introduction -->
        <div class="tutorial-page" id="page6">
            <h2>Interactive Practice</h2>
            <span class="practice-label">PRACTICE MODE</span>
            
            <p style="line-height: 1.8; margin-bottom: 20px;">
                Before starting the actual evaluation, let's walk through the process with a practice example. This will help you understand how to use the evaluation interface.
            </p>
            
            <p style="line-height: 1.8; margin-bottom: 15px;">
                The evaluation interface consists of <strong>three panels</strong>:
            </p>
            
            <!-- Three Panel Preview -->
            <div class="mock-three-panel">
                <!-- Left Panel: NFRs -->
                <div class="mock-panel">
                    <div class="mock-panel-header">
                        NFRs Display
                        <div class="mock-buttons">
                            <button class="mock-btn">ðŸ“‹ Code Structure</button>
                            <button class="mock-btn" onclick="openTutorialModal()">ðŸ“– Tutorial</button>
                        </div>
                    </div>
                    <div class="mock-panel-content">
                        <div class="mock-panel-step">
                            <strong>Step 1:</strong>
                            <ul style="margin: 6px 0 0 16px; padding-left: 16px;">
                                <li>Review each NFR.</li>
                                <li>Check the acknowledgement box for each NFR.</li>
                                <li>Explain one randomly selected NFR to unlock steps 2 and 3.</li>
                                <li>Press "Copy All NFRs" to ask them in one prompt, then start the conversation.</li>
                            </ul>
                        </div>
                        <div class="mock-batch-info">
                            Batch 1 of 3
                            <button class="mock-btn" style="background: #007bff; color: white; border: none; padding: 6px 12px; font-size: 12px;">ðŸ“‹ Copy All NFRs</button>
                        </div>
                        <div class="mock-nfr-item">
                            <h4>NFR 1: Example</h4>
                            <p>This panel displays all NFRs for the current batch.</p>
                        </div>
                    </div>
                </div>
                
                <!-- Middle Panel: Chatbot -->
                <div class="mock-panel">
                    <div class="mock-panel-header">Chatbot Assistant</div>
                    <div class="mock-chat-messages">
                        <div class="mock-panel-step">
                            <strong>Step 2:</strong>
                            Interact with the chatbot to get the following for each NFR:
                            <ul style="margin: 6px 0 0 16px; padding-left: 16px;">
                                <li>Satisfaction Level (Satisfied, Weakly Satisfied, Weakly Denied, Denied, or Not Applicable)</li>
                                <li>Reasoning for that level</li>
                                <li>Specific Code Locations that address the NFR</li>
                            </ul>
                        </div>
                        <div class="mock-message bot">
                            <div class="mock-message-content">Hello! I can help you evaluate NFRs. Paste the NFRs and I'll provide assessments.</div>
                        </div>
                    </div>
                    <div class="mock-chat-input">
                        <input type="text" placeholder="Type your message..." disabled>
                        <button class="btn" disabled>Send</button>
                    </div>
                </div>
                
                <!-- Right Panel: Feedback -->
                <div class="mock-panel">
                    <div class="mock-panel-header">Feedback Form</div>
                    <div class="mock-panel-content white-bg">
                        <div class="mock-panel-step">
                            <strong>Step 3:</strong>
                            <ul style="margin: 6px 0 0 16px; padding-left: 16px;">
                                <li>Once you're convinced the chatbot has fully assessed the NFRs, complete this feedback form for each NFR.</li>
                            </ul>
                        </div>
                        <div class="mock-form-section">
                            <h4>NFR 1: Example</h4>
                            <p style="font-size: 11px; color: #666;">Answer questions about the chatbot's evaluation.</p>
                        </div>
                    </div>
                </div>
            </div>
            
            <p style="margin-top: 20px; font-size: 14px; color: #333;">
                Press <strong>Next</strong> to continue.
            </p>
        </div>
        
        <!-- Page 7: Highlight Tutorial & Code Structure Buttons -->
        <div class="tutorial-page" id="page7">
            <h2>Access Guidelines Anytime</h2>
            <span class="practice-label">PRACTICE MODE</span>
            
            <p style="line-height: 1.8; margin-bottom: 20px;">
                During the actual evaluation, you can access the guidelines at any time using these buttons:
            </p>
            
            <!-- Three Panel Preview with Highlighted Buttons -->
            <div class="mock-three-panel">
                <!-- Left Panel: NFRs -->
                <div class="mock-panel" style="position: relative;">
                    <div class="mock-panel-header">
                        NFRs Display
                        <div class="mock-buttons highlight-buttons-box">
                            <button class="mock-btn">ðŸ“‹ Code Structure</button>
                            <button class="mock-btn" onclick="openTutorialModal()">ðŸ“– Tutorial</button>
                        </div>
                    </div>
                    <!-- Highlight callout below header -->
                    <div class="highlight-callout">
                        <div class="highlight-arrow-up">â†‘</div>
                        <div class="highlight-text-below">
                            You can review the guidelines at any time by clicking these buttons
                        </div>
                    </div>
                    <div class="mock-panel-content">
                        <div class="mock-panel-step">
                            <strong>Step 1:</strong>
                            <ul style="margin: 6px 0 0 16px; padding-left: 16px;">
                                <li>Review each NFR.</li>
                                <li>Check the acknowledgement box for each NFR.</li>
                                <li>Explain one randomly selected NFR to unlock steps 2 and 3.</li>
                                <li>Press "Copy All NFRs" to ask them in one prompt, then start the conversation.</li>
                            </ul>
                        </div>
                        <div class="mock-batch-info" style="position: relative;">
                            Batch 1 of 3
                            <button class="mock-btn highlight-buttons-box" style="background: #007bff; color: white; border: none; padding: 6px 12px; font-size: 12px;">ðŸ“‹ Copy All NFRs</button>
                            <!-- Highlight callout for Copy NFRs button -->
                            <div class="highlight-callout-copy">
                                <div class="highlight-arrow-up">â†‘</div>
                                <div class="highlight-text-below">
                                    You can copy all NFRs using this button
                                </div>
                            </div>
                        </div>
                        <div class="mock-nfr-item">
                            <h4>NFR 1: Example</h4>
                            <p>This panel displays all NFRs for the current batch.</p>
                        </div>
                    </div>
                </div>
                
                <!-- Middle Panel: Chatbot -->
                <div class="mock-panel">
                    <div class="mock-panel-header">Chatbot Assistant</div>
                    <div class="mock-chat-messages">
                        <div class="mock-panel-step">
                            <strong>Step 2:</strong>
                            Interact with the chatbot to get the following for each NFR:
                            <ul style="margin: 6px 0 0 16px; padding-left: 16px;">
                                <li>Satisfaction Level (Satisfied, Weakly Satisfied, Weakly Denied, Denied, or Not Applicable)</li>
                                <li>Reasoning for that level</li>
                                <li>Specific Code Locations that address the NFR</li>
                            </ul>
                        </div>
                        <div class="mock-message bot">
                            <div class="mock-message-content">Hello! I can help you evaluate NFRs. Paste the NFRs and I'll provide assessments.</div>
                        </div>
                    </div>
                    <div class="mock-chat-input">
                        <input type="text" placeholder="Type your message..." disabled>
                        <button class="btn" disabled>Send</button>
                    </div>
                </div>
                
                <!-- Right Panel: Feedback -->
                <div class="mock-panel">
                    <div class="mock-panel-header">Feedback Form</div>
                    <div class="mock-panel-content white-bg">
                        <div class="mock-panel-step">
                            <strong>Step 3:</strong>
                            <ul style="margin: 6px 0 0 16px; padding-left: 16px;">
                                <li>Once you're convinced the chatbot has fully assessed the NFRs, complete this feedback form for each NFR.</li>
                            </ul>
                        </div>
                        <div class="mock-form-section">
                            <h4>NFR 1: Example</h4>
                            <p style="font-size: 11px; color: #666;">Answer questions about the chatbot's evaluation.</p>
                        </div>
                    </div>
                </div>
            </div>
            
            <p style="margin-top: 20px; font-size: 14px; color: #333;">
                Press <strong>Next</strong> to practice Step 1.
            </p>
        </div>
        
        <!-- Page 8: Interactive Practice - Step 1 (NFRs with checkboxes) -->
        <div class="tutorial-page" id="page8">
            <h2>Step 1: Review the NFRs</h2>
            <span class="practice-label">PRACTICE MODE</span>
            <span class="step-indicator">Step 1 of 3</span>
            
            <p style="line-height: 1.8; margin-bottom: 15px;">
                Read and understand each NFR. Check the box below each NFR to acknowledge you have read it, then explain one NFR in your own words.
            </p>
            
            <!-- Three Panel Layout for Step 1 -->
            <div class="mock-three-panel">
                <!-- Left Panel: NFRs (Active) -->
                <div class="mock-panel" style="border: 3px solid #198754;">
                    <div class="mock-panel-header" style="background: #198754;">
                        NFRs Display
                        <div class="mock-buttons">
                            <button class="mock-btn">ðŸ“‹ Code Structure</button>
                            <button class="mock-btn" onclick="openTutorialModal()">ðŸ“– Tutorial</button>
                        </div>
                    </div>
                    <div class="mock-panel-content">
                        <div class="mock-panel-step">
                            <strong>Step 1:</strong>
                            <ul style="margin: 6px 0 0 16px; padding-left: 16px;">
                                <li>Review each NFR.</li>
                                <li>Check the acknowledgement box for each NFR.</li>
                                <li>Explain one randomly selected NFR to unlock steps 2 and 3.</li>
                                <li>Press "Copy All NFRs" to ask them in one prompt, then start the conversation.</li>
                            </ul>
                        </div>
                        
                        <div class="mock-batch-info">
                            Practice Batch: 3 sample NFRs
                            <button class="mock-btn" style="background: #007bff; color: white; border: none; padding: 6px 12px; font-size: 12px;">ðŸ“‹ Copy All NFRs</button>
                        </div>
                        
                        <!-- Sample NFR 1 -->
                        <div class="mock-nfr-item">
                            <h4>NFR 1: Password Security</h4>
                            <p>Users should be able to change their password that meets security requirements.</p>
                            <label class="mock-checkbox-label">
                                <input type="checkbox" id="mock_nfr_read_1" onchange="checkMockNfrBoxes()">
                                I have read and understood this NFR
                            </label>
                        </div>
                        
                        <!-- Sample NFR 2 -->
                        <div class="mock-nfr-item">
                            <h4>NFR 2: Data Encryption</h4>
                            <p>All patient data must be encrypted according to HIPAA standards.</p>
                            <label class="mock-checkbox-label">
                                <input type="checkbox" id="mock_nfr_read_2" onchange="checkMockNfrBoxes()">
                                I have read and understood this NFR
                            </label>
                        </div>
                        
                        <!-- Sample NFR 3 -->
                        <div class="mock-nfr-item">
                            <h4>NFR 3: Access Control</h4>
                            <p>The system must restrict access to patient records based on user roles and permissions.</p>
                            <label class="mock-checkbox-label">
                                <input type="checkbox" id="mock_nfr_read_3" onchange="checkMockNfrBoxes()">
                                I have read and understood this NFR
                            </label>
                        </div>
                        
                        <!-- Gate Question -->
                        <div class="mock-gate-card">
                            <div class="mock-gate-title">Before you continue</div>
                            <p style="font-size: 12px; color: #1f3f5b; margin-bottom: 8px;">
                                Please check all boxes above, then explain this NFR in your own words:
                            </p>
                            <div class="mock-gate-nfr">
                                <strong>NFR 2: Data Encryption</strong><br>
                                All patient data must be encrypted according to HIPAA standards.
                            </div>
                            <textarea class="mock-gate-textarea" id="mockGateAnswer" placeholder="Write your explanation here..."></textarea>
                            <div class="validation-error" id="mockGateError">Please check all boxes and provide an explanation to continue.</div>
                        </div>
                    </div>
                </div>
                
                <!-- Middle Panel: Chatbot (Locked) -->
                <div class="mock-panel" style="opacity: 0.5; filter: blur(1px);">
                    <div class="mock-panel-header">Chatbot Assistant</div>
                    <div class="mock-chat-messages">
                        <div class="mock-panel-step">
                            <strong>Step 2:</strong>
                            Interact with the chatbot to get the following for each NFR:
                            <ul style="margin: 6px 0 0 16px; padding-left: 16px;">
                                <li>Satisfaction Level (Satisfied, Weakly Satisfied, Weakly Denied, Denied, or Not Applicable)</li>
                                <li>Reasoning for that level</li>
                                <li>Specific Code Locations that address the NFR</li>
                            </ul>
                        </div>
                        <div class="mock-message bot">
                            <div class="mock-message-content">Complete Step 1 first to unlock the chatbot.</div>
                        </div>
                    </div>
                    <div class="mock-chat-input">
                        <input type="text" placeholder="Locked until Step 1 is complete..." disabled>
                        <button class="btn" disabled>Send</button>
                    </div>
                </div>
                
                <!-- Right Panel: Feedback (Locked) -->
                <div class="mock-panel" style="opacity: 0.5; filter: blur(1px);">
                    <div class="mock-panel-header">Feedback Form</div>
                    <div class="mock-panel-content white-bg">
                        <div class="mock-panel-step">
                            <strong>Step 3:</strong>
                            <ul style="margin: 6px 0 0 16px; padding-left: 16px;">
                                <li>Once you're convinced the chatbot has fully assessed the NFRs, complete this feedback form for each NFR.</li>
                            </ul>
                        </div>
                        <div class="mock-form-section">
                            <h4>NFR 1: Password Security</h4>
                            <p style="font-size: 11px; color: #666;">Locked until Steps 1 & 2 are complete.</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Page 9: Interactive Practice - Step 2 (Chatbot) -->
        <div class="tutorial-page" id="page9">
            <h2>Step 2: Interact with the Chatbot</h2>
            <span class="practice-label">PRACTICE MODE</span>
            <span class="step-indicator">Step 2 of 3</span>
            
            <p style="line-height: 1.8; margin-bottom: 15px;">
                Now that you've reviewed the NFRs, use the chatbot to evaluate them. Copy the NFRs and ask the chatbot to assess each one.
            </p>
            
            <!-- Three Panel Layout for Step 2 -->
            <div class="mock-three-panel">
                <!-- Left Panel: NFRs (Completed) -->
                <div class="mock-panel" style="opacity: 0.7;">
                    <div class="mock-panel-header" style="background: #6c757d;">
                        NFRs Display âœ“
                        <div class="mock-buttons">
                            <button class="mock-btn">ðŸ“‹ Code Structure</button>
                            <button class="mock-btn" onclick="openTutorialModal()">ðŸ“– Tutorial</button>
                        </div>
                    </div>
                    <div class="mock-panel-content">
                        <div class="mock-panel-step" style="background: #d4edda; border-color: #198754;">
                            <strong>Step 1: âœ“ Completed</strong>
                        </div>
                        <div class="mock-batch-info">
                            Practice Batch: 3 sample NFRs
                            <button class="mock-btn" style="background: #007bff; color: white; border: none; padding: 6px 12px; font-size: 12px;">ðŸ“‹ Copy All NFRs</button>
                        </div>
                        <div class="mock-nfr-item" style="opacity: 0.7;">
                            <h4>NFR 1: Password Security âœ“</h4>
                            <p>Users should be able to change their password...</p>
                        </div>
                        <div class="mock-nfr-item" style="opacity: 0.7;">
                            <h4>NFR 2: Data Encryption âœ“</h4>
                            <p>All patient data must be encrypted...</p>
                        </div>
                        <div class="mock-nfr-item" style="opacity: 0.7;">
                            <h4>NFR 3: Access Control âœ“</h4>
                            <p>The system must restrict access...</p>
                        </div>
                    </div>
                </div>
                
                <!-- Middle Panel: Chatbot (Active) -->
                <div class="mock-panel" style="border: 3px solid #198754;">
                    <div class="mock-panel-header" style="background: #198754;">Chatbot Assistant</div>
                    <div class="mock-chat-messages">
                        <div class="mock-panel-step">
                            <strong>Step 2:</strong>
                            Interact with the chatbot to get the following for each NFR:
                            <ul style="margin: 6px 0 0 16px; padding-left: 16px;">
                                <li>Satisfaction Level (Satisfied, Weakly Satisfied, Weakly Denied, Denied, or Not Applicable)</li>
                                <li>Reasoning for that level</li>
                                <li>Specific Code Locations that address the NFR</li>
                            </ul>
                        </div>
                        <div class="mock-message bot">
                            <div class="mock-message-content">Hello! I can help you evaluate NFRs. Paste the NFRs and I'll provide assessments.</div>
                        </div>
                        <div class="mock-message user">
                            <div class="mock-message-content" style="white-space: pre-line;">Please evaluate the following 3 NFRs. For each NFR, provide:
â€¢ Level of satisfaction
â€¢ Reasoning
â€¢ Relevant code locations (if applicable).

NFR 1: Password Security - Users should be able to change their password that meets security requirements.
NFR 2: Data Encryption - All patient data must be encrypted according to HIPAA standards.
NFR 3: Access Control - The system must restrict access to patient records based on user roles and permissions.</div>
                        </div>
                        <div class="mock-message bot">
                            <div class="mock-message-content">
                                <strong>NFR 1: Password Security</strong><br>
                                <strong>Level of satisfaction:</strong> Satisfied<br>
                                <strong>Reasoning:</strong> The iTrust system implements password change functionality with security requirements including minimum length, complexity rules, and password history checks.<br>
                                <strong>Relevant code locations:</strong> auth/ChangePasswordAction.java, validators/PasswordValidator.java<br><br>
                                <strong>NFR 2: Data Encryption</strong><br>
                                <strong>Level of satisfaction:</strong> Satisfied<br>
                                <strong>Reasoning:</strong> Patient data encryption is implemented through database encryption and secure transmission protocols.<br>
                                <strong>Relevant code locations:</strong> database/EncryptionUtil.java, security/HIPAACompliance.java<br><br>
                                <strong>NFR 3: Access Control</strong><br>
                                <strong>Level of satisfaction:</strong> Satisfied<br>
                                <strong>Reasoning:</strong> Role-based access control is enforced through authentication middleware and permission checks.<br>
                                <strong>Relevant code locations:</strong> auth/RoleBasedAccessControl.java, security/PermissionValidator.java
                            </div>
                        </div>
                    </div>
                    <div class="mock-chat-input">
                        <input type="text" placeholder="This is a demo - chatbot is not active" disabled>
                        <button class="btn" disabled>Send</button>
                    </div>
                </div>
                
                <!-- Right Panel: Feedback (Locked) -->
                <div class="mock-panel" style="opacity: 0.5; filter: blur(1px);">
                    <div class="mock-panel-header">Feedback Form</div>
                    <div class="mock-panel-content white-bg">
                        <div class="mock-panel-step">
                            <strong>Step 3:</strong>
                            <ul style="margin: 6px 0 0 16px; padding-left: 16px;">
                                <li>Once you're convinced the chatbot has fully assessed the NFRs, complete this feedback form for each NFR.</li>
                            </ul>
                        </div>
                        <div class="mock-form-section">
                            <h4>NFR 1: Password Security</h4>
                            <p style="font-size: 11px; color: #666;">Locked until Step 2 is complete.</p>
                        </div>
                    </div>
                </div>
            </div>
            
            <p style="margin-top: 20px; font-size: 14px; color: #333;">
                In the actual evaluation, you will interact with the chatbot to get assessments for each NFR. Press <strong>Next</strong> to see Step 3.
            </p>
        </div>
        
        <div class="navigation">
            <button class="btn btn-secondary" id="prevBtn" onclick="changePage(-1)" style="display: none;">Previous</button>
            <button class="btn" id="nextBtn" onclick="changePage(1)">Next</button>
        </div>
    </div>
</div>

<script>
const STATIC_PASSWORD = 'perc2026'; // Static password
let currentPage = 1;
const totalPages = 9;
let uuid = null;

// Get UUID from localStorage (should already exist from consent page)
window.addEventListener('load', () => {
    // Check if should redirect
    if (redirectToCorrectPage()) return;
    
    // Get UUID from localStorage - it should already exist from consent
    uuid = localStorage.getItem('chatbot_uuid');
    if (uuid) {
        // Validate UUID with server
        fetch('/api/get_or_create_uuid', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({uuid: uuid})
        })
        .then(r => r.json())
        .then(data => {
            uuid = data.uuid;
            localStorage.setItem('chatbot_uuid', uuid);
            setCurrentProgress(PROGRESS_STEPS.TUTORIAL, {page: currentPage});
            loadProgress();
        });
    } else {
        // UUID should exist - if not, redirect back to consent
        console.warn('No UUID found, redirecting to consent');
        window.location.href = '/';
    }
    
    // Check if modal should be opened
    const urlParams = new URLSearchParams(window.location.search);
    if (urlParams.get('modal') === 'true') {
        setTimeout(() => openTutorialModal(), 500);
    }
});


function loadProgress() {
    // Load page progress from localStorage
    const savedPage = localStorage.getItem('tutorial_page');
    if (savedPage) {
        currentPage = parseInt(savedPage);
        showPage(currentPage);
    } else {
        showPage(currentPage);
    }
}

function showPage(page) {
    // Hide all pages
    for (let i = 1; i <= totalPages; i++) {
        document.getElementById(`page${i}`).classList.remove('active');
    }
    
    // Show current page
    document.getElementById(`page${page}`).classList.add('active');
    document.getElementById('pageNum').textContent = page;
    document.getElementById('totalPages').textContent = totalPages;
    
    // Update navigation buttons
    document.getElementById('prevBtn').style.display = page === 1 ? 'none' : 'block';
    document.getElementById('nextBtn').textContent = page === totalPages ? 'Start Evaluation' : 'Next';
    
    // Make container wider for practice pages (6, 7, etc.)
    const container = document.querySelector('.tutorial-container');
    if (page >= 6) {
        container.classList.add('wide');
    } else {
        container.classList.remove('wide');
    }
}

function changePage(direction) {
    if (direction === 1) {
        // Validate current page before proceeding
        if (currentPage === 5) {
            // Validate password
            const password = document.getElementById('password').value;
            if (password !== STATIC_PASSWORD) {
                document.getElementById('passwordError').style.display = 'block';
                return;
            }
        }
        
        // Validate page 8 - mock NFR acknowledgment and explanation
        if (currentPage === 8) {
            const allChecked = checkMockNfrBoxes();
            const explanation = document.getElementById('mockGateAnswer').value.trim();
            
            if (!allChecked || !explanation) {
                document.getElementById('mockGateError').style.display = 'block';
                return;
            }
            document.getElementById('mockGateError').style.display = 'none';
        }
        
        if (currentPage === totalPages) {
            // Save progress and go to evaluation
            localStorage.setItem('tutorial_page', currentPage.toString());
            setCurrentProgress(PROGRESS_STEPS.EVALUATION, {batch: 1});
            window.location.href = '/evaluation?batch=1';
            return;
        }
        currentPage++;
    } else {
        currentPage--;
    }
    
    showPage(currentPage);
    // Save page progress to localStorage
    localStorage.setItem('tutorial_page', currentPage.toString());
    setCurrentProgress(PROGRESS_STEPS.TUTORIAL, {page: currentPage});
}

// Check if all mock NFR checkboxes are checked
function checkMockNfrBoxes() {
    const cb1 = document.getElementById('mock_nfr_read_1');
    const cb2 = document.getElementById('mock_nfr_read_2');
    const cb3 = document.getElementById('mock_nfr_read_3');
    
    if (!cb1 || !cb2 || !cb3) return false;
    
    const allChecked = cb1.checked && cb2.checked && cb3.checked;
    
    // Update visual feedback
    if (allChecked) {
        document.getElementById('mockGateError').style.display = 'none';
    }
    
    return allChecked;
}

showPage(currentPage);
</script>
{% endblock %}
