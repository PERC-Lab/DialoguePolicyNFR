{% extends "base.html" %}

{% block title %}Tutorial{% endblock %}

{% block extra_css %}
<style>
    .tutorial-container {
        max-width: 900px;
        margin: 40px auto;
        background: white;
        padding: 40px;
        border-radius: 8px;
        box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    }
    .tutorial-container.wide {
        max-width: 1400px;
    }
    .tutorial-page {
        display: none;
    }
    .tutorial-page.active {
        display: block;
    }
    .tutorial-page h2 {
        margin-bottom: 20px;
        color: #333;
    }
    .tutorial-page p {
        margin-bottom: 15px;
        line-height: 1.8;
    }
    .form-group {
        margin-bottom: 20px;
    }
    .form-group label {
        display: block;
        margin-bottom: 8px;
        font-weight: 600;
    }
    .form-group input, .form-group select, .form-group textarea {
        width: 100%;
        padding: 10px;
        border: 1px solid #ddd;
        border-radius: 4px;
        font-size: 14px;
    }
    .form-group textarea {
        resize: vertical;
        min-height: 100px;
    }
    .navigation {
        display: flex;
        justify-content: space-between;
        margin-top: 30px;
        padding-top: 20px;
        border-top: 1px solid #eee;
    }
    .page-indicator {
        text-align: center;
        margin-bottom: 20px;
        color: #666;
    }
    
    /* Three Panel Layout */
    .mock-three-panel {
        display: flex;
        gap: 15px;
        margin-top: 20px;
        min-height: 500px;
    }
    .mock-panel {
        flex: 1;
        background: white;
        border-radius: 8px;
        box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        display: flex;
        flex-direction: column;
        overflow: hidden;
    }
    .mock-panel-header {
        padding: 12px 15px;
        background: #007bff;
        color: white;
        font-weight: 600;
        font-size: 14px;
        display: flex;
        justify-content: space-between;
        align-items: center;
    }
    .mock-panel-content {
        flex: 1;
        padding: 15px;
        overflow-y: auto;
        background: #f8f9fa;
    }
    .mock-panel-content.white-bg {
        background: white;
    }
    
    /* Mock Buttons */
    .mock-buttons {
        display: flex;
        gap: 8px;
    }
    .mock-btn {
        padding: 4px 10px;
        background: rgba(255, 255, 255, 0.2);
        color: white;
        border: 1px solid rgba(255, 255, 255, 0.3);
        border-radius: 4px;
        cursor: pointer;
        font-size: 11px;
        transition: background 0.3s;
    }
    .mock-btn:hover {
        background: rgba(255, 255, 255, 0.3);
    }
    
    /* NFR Items */
    .mock-nfr-item {
        margin-bottom: 12px;
        padding: 12px;
        background: white;
        border-radius: 4px;
        border-left: 4px solid #007bff;
    }
    .mock-nfr-item h4 {
        margin-bottom: 6px;
        color: #333;
        font-size: 13px;
        font-weight: 600;
    }
    .mock-nfr-item p {
        margin: 0 0 8px 0;
        color: #666;
        font-size: 12px;
        line-height: 1.4;
    }
    .mock-checkbox-label {
        font-size: 12px;
        display: flex;
        align-items: center;
        gap: 6px;
        cursor: pointer;
        font-weight: normal;
    }
    .mock-checkbox-label input {
        width: auto;
    }
    
    /* Gate Card */
    .mock-gate-card {
        background: #fff;
        border: 1px solid #cfe2ff;
        border-left: 4px solid #0d6efd;
        border-radius: 8px;
        padding: 12px;
        margin-top: 15px;
    }
    .mock-gate-title {
        font-weight: 700;
        margin-bottom: 6px;
        font-size: 13px;
        color: #0b2e4c;
    }
    .mock-gate-nfr {
        background: #f1f7ff;
        border: 1px solid #cfe2ff;
        border-radius: 6px;
        padding: 10px;
        font-size: 12px;
        line-height: 1.4;
        margin-bottom: 10px;
    }
    .mock-gate-textarea {
        width: 100%;
        min-height: 60px;
        border: 1px solid #cfe2ff;
        border-radius: 6px;
        padding: 8px 10px;
        font-size: 12px;
        font-family: inherit;
        resize: vertical;
    }
    
    /* Chat Messages */
    .mock-chat-messages {
        flex: 1;
        padding: 15px;
        overflow-y: auto;
        background: #f8f9fa;
    }
    .mock-message {
        margin-bottom: 12px;
    }
    .mock-message.user {
        text-align: right;
    }
    .mock-message.bot {
        text-align: left;
    }
    .mock-message-content {
        display: block;
        width: 85%;
        max-width: 85%;
        box-sizing: border-box;
        padding: 8px 12px;
        border-radius: 12px;
        font-size: 12px;
        line-height: 1.4;
        white-space: pre-wrap;
        word-wrap: break-word;
        overflow-wrap: break-word;
        word-break: break-word;
    }
    .mock-message.user .mock-message-content {
        margin-left: auto;
        background: #007bff;
        color: white;
        text-align: left;
    }
    .mock-message.bot .mock-message-content {
        background: white;
        color: #333;
        border: 1px solid #ddd;
    }
    .mock-chat-input {
        padding: 10px;
        border-top: 1px solid #ddd;
        display: flex;
        gap: 8px;
        background: white;
    }
    .mock-chat-input input {
        flex: 1;
        padding: 8px;
        border: 1px solid #ddd;
        border-radius: 4px;
        font-size: 12px;
    }
    .mock-chat-input button {
        padding: 8px 15px;
        font-size: 12px;
    }
    
    /* Feedback Form */
    .mock-form-section {
        margin-bottom: 15px;
        padding: 12px;
        background: #f8f9fa;
        border-radius: 4px;
        border: 1px solid #ddd;
    }
    .mock-form-section h4 {
        margin-bottom: 10px;
        color: #333;
        font-size: 12px;
    }
    .mock-form-group {
        margin-bottom: 10px;
    }
    .mock-form-group label {
        display: block;
        margin-bottom: 5px;
        font-weight: 600;
        font-size: 11px;
    }
    .mock-radio-group {
        display: flex;
        gap: 8px;
        flex-wrap: wrap;
    }
    .mock-radio-group label {
        display: flex;
        align-items: center;
        font-weight: normal;
        cursor: pointer;
        font-size: 11px;
    }
    .mock-radio-group input[type="radio"] {
        margin-right: 4px;
        width: auto;
    }
    
    /* Step Indicators */
    .step-indicator {
        display: inline-block;
        background: #007bff;
        color: white;
        padding: 4px 12px;
        border-radius: 20px;
        font-size: 12px;
        font-weight: 600;
        margin-bottom: 15px;
    }
    .info-box {
        background: #e7f3ff;
        border: 1px solid #b6d4fe;
        border-radius: 8px;
        padding: 15px;
        margin-bottom: 20px;
    }
    .info-box p {
        margin: 0;
        color: #0a58ca;
        font-size: 14px;
    }
    
    /* Highlight Callout - Floating overlay below buttons */
    .highlight-callout {
        position: absolute;
        top: 45px;
        right: 15px;
        display: flex;
        flex-direction: column;
        align-items: center;
        z-index: 100;
    }
    .highlight-arrow-up {
        font-size: 32px;
        color: #ff8c00;
        font-weight: bold;
        line-height: 1;
        animation: pulse-arrow-up 1s ease-in-out infinite;
    }
    @keyframes pulse-arrow-up {
        0%, 100% { transform: translateY(0); }
        50% { transform: translateY(-5px); }
    }
    .highlight-text-below {
        background: #ff8c00;
        border-radius: 6px;
        padding: 12px 20px;
        color: white;
        font-weight: 600;
        font-size: 14px;
        max-width: 280px;
        text-align: center;
        box-shadow: 0 4px 12px rgba(0,0,0,0.3);
    }
    
    /* Highlight callout for Copy NFRs button */
    .highlight-callout-copy {
        position: absolute;
        top: 35px;
        right: 0;
        display: flex;
        flex-direction: column;
        align-items: flex-end;
        z-index: 100;
    }
    .highlight-callout-copy .highlight-arrow-up {
        margin-right: 45px;
    }
    .highlight-callout-copy .highlight-text-below {
        max-width: 200px;
    }
    
    /* Allow overflow for callouts */
    #page9 .mock-panel {
        overflow: visible !important;
    }
    #page9 .mock-panel-content {
        overflow: visible !important;
    }
    #page9 .mock-batch-info {
        overflow: visible !important;
    }
    #page9 .mock-three-panel {
        overflow: visible !important;
    }
    
    /* Step 1.1 Code Navigation */
    .mvc-diagram {
        background: #f8f9fa;
        border: 1px solid #dee2e6;
        border-radius: 6px;
        padding: 20px;
        font-size: 12px;
        overflow-x: auto;
    }
    .code-layer-card {
        background: #f8f9fa;
        border-left: 4px solid #007bff;
        padding: 15px 20px;
        margin-bottom: 15px;
        border-radius: 4px;
    }
    .code-layer-card h4 {
        margin-bottom: 10px;
        color: #333;
    }
    .code-layer-card code {
        background: #e9ecef;
        padding: 2px 6px;
        border-radius: 4px;
        font-size: 13px;
    }
    .nfr-highlight-box {
        background: #fff3cd;
        border: 2px solid #ffc107;
        border-radius: 8px;
        padding: 20px;
        margin: 20px 0;
        font-size: 16px;
    }
    
    /* Red box around buttons */
    .highlight-buttons-box {
        border: 3px solid #dc3545 !important;
        border-radius: 6px;
        padding: 4px !important;
        background: rgba(220, 53, 69, 0.1);
        animation: pulse-border 1.5s ease-in-out infinite;
    }
    @keyframes pulse-border {
        0%, 100% { box-shadow: 0 0 0 0 rgba(220, 53, 69, 0.4); }
        50% { box-shadow: 0 0 0 6px rgba(220, 53, 69, 0); }
    }
    .practice-label {
        display: inline-block;
        background: #198754;
        color: white;
        padding: 3px 10px;
        border-radius: 4px;
        font-size: 11px;
        font-weight: 600;
        margin-bottom: 10px;
    }
    .validation-error {
        color: #dc3545;
        font-size: 13px;
        margin-top: 8px;
        display: none;
    }
    
    /* Batch Info */
    .mock-batch-info {
        padding: 8px 12px;
        background: #e9ecef;
        border-radius: 4px;
        margin-bottom: 12px;
        font-weight: 600;
        font-size: 12px;
        display: flex;
        justify-content: space-between;
        align-items: center;
    }
    
    /* Panel Step Info */
    .mock-panel-step {
        background: #f1f7ff;
        border: 1px solid #cfe2ff;
        border-left: 4px solid #007bff;
        border-radius: 6px;
        padding: 10px;
        margin-bottom: 12px;
        font-size: 12px;
        color: #0b2e4c;
        line-height: 1.4;
    }
    .mock-panel-step strong {
        font-weight: 700;
    }
</style>
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/intro.js@7.2.0/minified/introjs.min.css">
{% endblock %}

{% block content %}
<div class="container">
    <div class="tutorial-container">
            <div class="page-indicator">
            <span id="pageNum">1</span> / <span id="totalPages">10</span>
        </div>
        
        <!-- Page 1: Overview -->
        <div class="tutorial-page active" id="page1">
            <h2>Overview</h2>
            <p style="line-height: 1.8; margin-bottom: 20px;">
                This tool facilitates the evaluation of Non-Functional Requirements (NFRs) from Healthcare regulations through interactive dialogue with a chatbot. You will work through batches of NFRs, engage with the chatbot to obtain assessments, and provide feedback on the chatbot's evaluations.
            </p>
            <p style="line-height: 1.8; margin-bottom: 20px;">
                <strong>You can reopen this tutorial at any time during the evaluation if you need a refresher.</strong>
            </p>
        </div>
        
        <!-- Page 2: What are NFRs? -->
        <div class="tutorial-page" id="page2">
            <h2>What are Non-Functional Requirements (NFRs)?</h2>
            <p style="line-height: 1.8; margin-bottom: 20px;">
                Non-Functional Requirements (NFRs) specify how a system should perform rather than what it should do.
            </p>
            <p style="line-height: 1.8; margin-bottom: 10px;">
                <strong>Example of functional requirement:</strong> "User can reset password"
            </p>
            <p style="line-height: 1.8; margin-bottom: 20px;">
                <strong>Example of NFR:</strong> The system must allow users to change passwords using secure storage methods
            </p>
        </div>
        
        <!-- Page 3: Download Code -->
        <div class="tutorial-page" id="page3">
            <h2>Download the Code</h2>
            <p style="line-height: 1.8; margin-bottom: 20px;">
                You will be evaluating NFRs against the <strong>iTrust</strong> codebase, an Electronic Health Record (EHR) system designed to comply with healthcare regulations.
            </p>
            <p><strong>Instructions:</strong></p>
            <ol style="margin-left: 20px; line-height: 2; margin-bottom: 30px;">
                <li>Click the button below to download the code package</li>
                <li>Extract the files to a location on your computer</li>
                <li>Open the project in your preferred code editor (VS Code, IntelliJ, etc.)</li>
            </ol>
            <div style="margin-top: 30px; text-align: center;">
                <a href="/static/iTrust.zip" download="iTrust.zip" class="btn" style="display: inline-block; text-decoration: none;">
                    ğŸ“¦ Download iTrust.zip
                </a>
            </div>
        </div>
        
        <!-- Page 4: Verification -->
        <div class="tutorial-page" id="page4">
            <h2>Verification Entry</h2>
            <p style="line-height: 1.8; margin-bottom: 15px;">
                Please confirm you have successfully downloaded and extracted the code.
            </p>
            <p style="line-height: 1.8; margin-bottom: 20px;">
                In the downloaded folder, open the file named <strong>"verification.txt"</strong>
            </p>
            
            <div class="form-group">
                <label for="password">What is the verification password written in this "verification.txt"?</label>
                <input type="text" id="password" placeholder="Enter password">
            </div>
            
            <div id="passwordError" style="color: red; margin-top: 10px; display: none;">
                Incorrect password. Please try again.
            </div>
        </div>
        
        <!-- Page 5: Code structure - Let's review the code structure first -->
        <div class="tutorial-page" id="page5">
            <h2>Let's review the code structure first</h2>
            <span class="practice-label">CODE NAVIGATION</span>
            
            <p style="line-height: 1.8; margin-bottom: 20px;">
                The codebase follows a <strong>Model-View-Controller (MVC)</strong> architecture.
            </p>

            <ul style="margin-left: 20px; line-height: 2; margin-bottom: 20px;">
                <li><strong>Model:</strong>
                    <ul style="margin-top: 4px; padding-left: 22px;">
                        <li>Data and business logic (database operations)</li>
                        <li>Located at: <code>src/main/edu/ncsu/csc/itrust/model/old/dao/mysql/*.java</code></li>
                            </ul>
                </li>
                <li><strong>View:</strong>
                    <ul style="margin-top: 4px; padding-left: 22px;">
                        <li>What the user sees and interacts with (UI)</li>
                        <li>Located at: <code>WebRoot/*.jsp</code></li>
                            </ul>
                </li>
                <li><strong>Controller:</strong>
                    <ul style="margin-top: 4px; padding-left: 22px;">
                        <li>Handles user input and coordinates between Model and View</li>
                        <li>Located at: <code>src/main/edu/ncsu/csc/itrust/action/*.java</code></li>
                            </ul>
                </li>
            </ul>
            
            <h3 style="margin-bottom: 15px;">MVC Structure in iTrust</h3>
            <pre class="mvc-diagram">â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                         CLIENT BROWSER                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                             â”‚ HTTP Request
                             â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    VIEW LAYER (JSPs)                        â”‚
â”‚  Location: WebRoot/auth/*.jsp                               â”‚
â”‚  - User interface (HTML, JavaScript)                        â”‚
â”‚  - Form submission                                          â”‚
â”‚  - Display data                                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                             â”‚ Calls Action classes
                             â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                 CONTROLLER LAYER (Actions)                  â”‚
â”‚  Location: src/main/edu/ncsu/csc/itrust/action/*.java       â”‚
â”‚  - Business logic coordination                              â”‚
â”‚  - Input validation                                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                             â”‚ Uses DAOs
                             â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                   MODEL LAYER                               â”‚
â”‚  Location: model/old/dao/mysql/*.java                       â”‚
â”‚  - Database operations (SQL queries)                        â”‚
â”‚  - Data access                                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜</pre>
        </div>
        
        <!-- Page 6: View Layer Quiz -->
        <div class="tutorial-page" id="page6">
            <p style="line-height: 1.8; margin-bottom: 10px;">
                Let's find the relevant code for this NFR:
            </p>
            <div class="nfr-highlight-box" style="margin-bottom: 20px;">
                <strong>NFR 1:</strong> "The system must allow users to change passwords using secure storage methods"
            </div>
            
            <h2>Finding the View Layer</h2>
            <span class="practice-label">CODE NAVIGATION</span>
            
            <p style="line-height: 1.8; margin-bottom: 15px;">
                <strong>Finding the View Layer:</strong> Located at <code>WebRoot/auth/*.jsp</code>. By looking at the files in this section, you can see many related files, such as the login page (<code>login.jsp</code>). The auth folder contains authenticated pages organized by user role (e.g., patient, hcp) with general pages directly in the auth folder.
            </p>
            
            <pre class="mvc-diagram">â”œâ”€â”€ WebRoot/                         # Web application root (deployed as WAR)
â”‚   â”œâ”€â”€ auth/                        # Protected pages (role-based)
â”‚   â”‚   â”œâ”€â”€ hcp/                     # Healthcare Provider only
â”‚   â”‚   â”œâ”€â”€ hcp-uap/                 # HCP and UAP shared
â”‚   â”‚   â”œâ”€â”€ patient/                 # Patient only
â”‚   â”‚   â”œâ”€â”€ admin/                   # Administrator only
â”‚   â”‚   â”œâ”€â”€ er/                      # Emergency Responder only
â”‚   â”‚   â”œâ”€â”€ pha/                     # Public Health Agent only
â”‚   â”‚   â””â”€â”€ staff/                   # All staff (HCP, UAP, Admin, LT)
â”‚   â”œâ”€â”€ errors/                      # Error pages (403, 404, 503)
â”‚   â”œâ”€â”€ util/                        # Utility JSPs
â”‚   â”œâ”€â”€ css/                         # Stylesheets
â”‚   â”œâ”€â”€ js/                          # JavaScript files
â”‚   â”œâ”€â”€ image/                       # Images
â”‚   â”œâ”€â”€ login.jsp                    # Login page
â”‚   â”œâ”€â”€ global.jsp                   # Global initialization (DAO, session)
â”‚   â”œâ”€â”€ header.jsp                   # Common header
â”‚   â”œâ”€â”€ footer.jsp                   # Common footer</pre>

            <p style="line-height: 1.8; margin-bottom: 15px;">
                For this NFR, which file in View Layer is relevant?
            </p>
            
            <div class="form-group">
                <label>WebRoot/auth/ <input type="text" id="viewLayerAnswer" placeholder="______" style="width: 150px; display: inline-block; margin: 0 4px;"> .jsp</label>
            </div>
            
            <div id="viewLayerError" style="color: red; margin-top: 10px; display: none;">
                Incorrect. Try again. Hint: think about what the file in this folder changes the password.
            </div>
            
            <div id="viewLayerSuccess" style="display: none; margin-top: 20px;">
                <p style="color: #198754; font-weight: 600; margin-bottom: 15px;">âœ“ Correct! The relevant file is changePassword.jsp</p>
                <img src="/static/images/code1.png" alt="Code view for changePassword" style="max-width: 100%; border: 1px solid #ddd; border-radius: 4px;">
            </div>
        </div>
        
        <!-- Page 7: Controller/Action Layer -->
        <div class="tutorial-page" id="page7">
            <p style="line-height: 1.8; margin-bottom: 10px;">
                Let's find the relevant code for this NFR:
            </p>
            <div class="nfr-highlight-box" style="margin-bottom: 20px;">
                <strong>NFR 1:</strong> "The system must allow users to change passwords using secure storage methods"
            </div>
            
            <h2>Finding the Controller/Action Layer</h2>
            <span class="practice-label">CODE NAVIGATION</span>
            
            <p style="line-height: 1.8; margin-bottom: 15px;">
                <strong>Finding the Controller/Action Layer:</strong> Located at <code>src/main/edu/ncsu/csc/itrust/action/*.java</code>. By reviewing the files in this section, you can see all the actions available in the format of [Feature]Action.java. In changePassword.jsp line 1, you'll see it imports an Action class.
            </p>
            
            <pre class="mvc-diagram">â”œâ”€â”€ src/main/
â”‚   â””â”€â”€ edu/ncsu/csc/itrust/
â”‚       â”œâ”€â”€ action/                  # CONTROLLER LAYER
â”‚       â”‚   â”œâ”€â”€ AddPatientAction.java
â”‚       â”‚   â”œâ”€â”€ EditPatientAction.java
â”‚       â”‚   â”œâ”€â”€ ViewMyRecordsAction.java
â”‚       â”‚   â””â”€â”€ ... (63+ action classes)</pre>

            <p style="line-height: 1.8; margin-bottom: 15px;">
                For this NFR, which file in Controller Layer is relevant?
            </p>
            
            <div class="form-group">
                <label>src/main/edu/ncsu/csc/itrust/action/ <input type="text" id="controllerLayerAnswer" placeholder="______" style="width: 220px; display: inline-block; margin: 0 4px;"> .java</label>
            </div>
            
            <div id="controllerLayerError" style="color: red; margin-top: 10px; display: none;">
                Incorrect. Try again. Hint: check which action is imported from previous layer.
            </div>
            
            <div id="controllerLayerSuccess" style="display: none; margin-top: 20px;">
                <p style="color: #198754; font-weight: 600; margin-bottom: 15px;">âœ“ Correct! The relevant file is ChangePasswordAction.java</p>
                <img src="/static/images/code2.png" alt="ChangePasswordAction code" style="max-width: 100%; border: 1px solid #ddd; border-radius: 4px;">
            </div>
        </div>
        
        <!-- Page 8: Model Layer -->
        <div class="tutorial-page" id="page8">
            <p style="line-height: 1.8; margin-bottom: 10px;">
                Let's find the relevant code for this NFR:
            </p>
            <div class="nfr-highlight-box" style="margin-bottom: 20px;">
                <strong>NFR 1:</strong> "The system must allow users to change passwords using secure storage methods"
            </div>
            
            <h2>Finding the Model Layer</h2>
            <span class="practice-label">CODE NAVIGATION</span>
            
            <p style="line-height: 1.8; margin-bottom: 15px;">
                <strong>Finding the Model Layer:</strong> Located at <code>src/main/edu/ncsu/csc/itrust/model/old/dao/mysql/*.java</code>. By looking at the Action class imports to find the DAO. ChangePasswordAction.java imports and uses a DAO for authentication operations.
            </p>
            
            <pre class="mvc-diagram">â”‚       â”œâ”€â”€ model/                   # MODEL LAYER
â”‚       â”‚   â”œâ”€â”€ old/
â”‚       â”‚   â”‚   â”œâ”€â”€ beans/           # Data containers
â”‚       â”‚   â”‚   â”‚   â”œâ”€â”€ PatientBean.java
â”‚       â”‚   â”‚   â”‚   â”œâ”€â”€ OfficeVisitBean.java
â”‚       â”‚   â”‚   â”‚   â””â”€â”€ ... (31+ bean classes)
â”‚       â”‚   â”‚   â”‚
â”‚       â”‚   â”‚   â”œâ”€â”€ dao/             # Database access
â”‚       â”‚   â”‚   â”‚   â”œâ”€â”€ DAOFactory.java      # Singleton factory
â”‚       â”‚   â”‚   â”‚   â””â”€â”€ mysql/
â”‚       â”‚   â”‚   â”‚       â”œâ”€â”€ PatientDAO.java
â”‚       â”‚   â”‚   â”‚       â”œâ”€â”€ OfficeVisitDAO.java
â”‚       â”‚   â”‚   â”‚       â””â”€â”€ ... (24+ DAO classes)
â”‚       â”‚   â”‚   â”‚
â”‚       â”‚   â”‚   â””â”€â”€ validate/        # Input validation
â”‚       â”‚   â”‚       â”œâ”€â”€ AddPatientValidator.java
â”‚       â”‚   â”‚       â””â”€â”€ ... (validator classes)</pre>
         
            <p style="line-height: 1.8; margin-bottom: 15px;">
                For this NFR, which file in Model Layer is relevant?
            </p>
            
            <div class="form-group">
                <label>src/main/edu/ncsu/csc/itrust/model/old/dao/mysql/ <input type="text" id="modelLayerAnswer" placeholder="______" style="width: 120px; display: inline-block; margin: 0 4px;"> .java</label>
            </div>
            
            <div id="modelLayerError" style="color: red; margin-top: 10px; display: none;">
                Incorrect. Try again. Hint: think about authentication.
            </div>
            
            <div id="modelLayerSuccess" style="display: none; margin-top: 20px;">
                <p style="color: #198754; font-weight: 600; margin-bottom: 15px;">âœ“ Correct! The relevant file is AuthDAO.java</p>
                <img src="/static/images/code3.png" alt="AuthDAO code" style="max-width: 100%; border: 1px solid #ddd; border-radius: 4px;">
            </div>
        </div>
        
        <!-- Page 9: Evaluation replica (no backend) -->
        <div class="tutorial-page" id="page9">
            <h2>You're Ready!</h2>
            <span class="practice-label">PRACTICE COMPLETE</span>
            <p style="line-height: 1.8; margin-bottom: 15px;">This is what the evaluation interface looks like.</p>
            <p style="margin-bottom: 15px;">
                <button type="button" class="btn btn-secondary" id="tour-redo-btn" style="font-size: 13px;">Redo tour</button>
            </p>
            <div class="mock-three-panel" style="min-height: 550px;">
                <!-- Left: NFRs Display (replica of evaluation) -->
                <div class="mock-panel" id="tour-nfr-panel">
                    <div class="mock-panel-header">
                        NFRs Display
                        <div class="mock-buttons" id="tour-tutorial-buttons">
                            <button class="mock-btn" type="button">ğŸ“‹ Code Structure</button>
                            <button class="mock-btn" type="button" onclick="openTutorialModal()">ğŸ“– Tutorial</button>
                        </div>
                    </div>
                    <div class="mock-panel-content">
                        <div class="mock-batch-info" style="padding: 10px; background: #e9ecef; border-radius: 4px; margin-bottom: 15px; font-weight: 600; display: flex; justify-content: space-between; align-items: center;">
                            Batch 1 of 1
                            <button class="mock-btn" type="button" id="tour-copy-btn" style="background: #007bff; color: white; border: none; padding: 6px 12px; font-size: 12px;">ğŸ“‹ Copy All NFRs</button>
                        </div>
                        <div id="tour-nfr-boxes">
                        <div class="mock-nfr-item">
                            <h4>NFR 1: Password Security</h4>
                            <p>The system must allow users to change passwords using secure storage methods</p>
                            <label class="mock-checkbox-label" style="margin-top: 10px;">
                                <input type="checkbox" id="tour-nfr-cb-1">
                                I have read and understood this NFR
                            </label>
                        </div>
                        <div class="mock-nfr-item">
                            <h4>NFR 2: Performance</h4>
                            <p>The system must load patient records within 2 seconds.</p>
                            <label class="mock-checkbox-label" style="margin-top: 10px;">
                                <input type="checkbox" id="tour-nfr-cb-2">
                                I have read and understood this NFR
                            </label>
                        </div>
                        <div class="mock-nfr-item">
                            <h4>NFR 3: Usability</h4>
                            <p>The interface must be accessible to users with visual impairments.</p>
                            <label class="mock-checkbox-label" style="margin-top: 10px;">
                                <input type="checkbox" id="tour-nfr-cb-3">
                                I have read and understood this NFR
                            </label>
                        </div>
                        <div id="tour-nfr-error" style="display: none; color: #c00; font-size: 13px; margin-top: 10px; font-weight: 600;">Please check all NFR acknowledgement boxes first.</div>
                    </div>
                    </div>
                </div>
                
                <!-- Middle: Chatbot (empty until user sends in tour) -->
                <div class="mock-panel" id="tour-chat-panel">
                    <div class="mock-panel-header">Chatbot Assistant</div>
                    <div class="mock-chat-messages" id="tour-chat-messages">
                        <div id="tour-chat-first-message" class="mock-message user" style="display: none;">
                            <div class="mock-message-content" style="white-space: pre-wrap; text-align: left;"></div>
                            </div>
                        </div>
                    <div class="mock-chat-input" id="tour-chat-input-area" style="flex-wrap: wrap;">
                        <textarea id="tour-chat-input" placeholder="Type your message... (Write and press Send to continue the tour)" rows="3" style="flex: 1; min-height: 60px; resize: vertical; padding: 8px; border: 1px solid #ddd; border-radius: 4px; font-size: 12px; font-family: inherit;"></textarea>
                        <button class="btn" id="tour-chat-send">Send</button>
                        <div id="tour-chat-error" style="display: none; color: #c00; font-size: 12px; margin-top: 6px; width: 100%; flex-basis: 100%;">Please write a message and press Send to continue.</div>
                    </div>
                </div>
                
                <!-- Right: Feedback Form (NFR 1 enabled for tour step 12) -->
                <div class="mock-panel" id="tour-feedback-form">
                    <div class="mock-panel-header">Feedback Form</div>
                    <div class="mock-panel-content white-bg">
                        <div id="tour-feedback-error" style="display: none; color: #c00; font-size: 13px; margin-bottom: 10px; font-weight: 600;">Please answer required questions for NFR 1.</div>
                        <div class="mock-form-section">
                            <h4>NFR 1: Password Security</h4>
                            <div class="mock-form-group">
                                <label>Question 1: Based on the conversations, do you agree with the chatbot's satisfaction level assessment?<span style="color: #c00;">*</span></label>
                                <div class="mock-radio-group">
                                    <label><input type="radio" name="demo_q1_1" value="agree"> Agree</label>
                                    <label><input type="radio" name="demo_q1_1" value="partially_agree"> Partially agree</label>
                                    <label><input type="radio" name="demo_q1_1" value="partially_disagree"> Partially disagree</label>
                                    <label><input type="radio" name="demo_q1_1" value="disagree"> Disagree</label>
                                </div>
                            </div>
                            <div class="mock-form-group">
                                <label>Question 2: Based on the conversations, do you agree with the chatbot's reasoning?<span style="color: #c00;">*</span></label>
                                <div class="mock-radio-group">
                                    <label><input type="radio" name="demo_q2_1" value="agree"> Agree</label>
                                    <label><input type="radio" name="demo_q2_1" value="partially_agree"> Partially agree</label>
                                    <label><input type="radio" name="demo_q2_1" value="partially_disagree"> Partially disagree</label>
                                    <label><input type="radio" name="demo_q2_1" value="disagree"> Disagree</label>
                                </div>
                            </div>
                            <div class="mock-form-group">
                                <label>Question 3: Based on the conversations, do you agree with the chatbot's identified code locations?<span style="color: #c00;">*</span></label>
                                <div class="mock-radio-group">
                                    <label><input type="radio" name="demo_q3_1" value="agree"> Agree</label>
                                    <label><input type="radio" name="demo_q3_1" value="partially_agree"> Partially agree</label>
                                    <label><input type="radio" name="demo_q3_1" value="partially_disagree"> Partially disagree</label>
                                    <label><input type="radio" name="demo_q3_1" value="disagree"> Disagree</label>
                                </div>
                            </div>
                            <div class="mock-form-group">
                                <label>Undecided? Explain why:</label>
                                <textarea disabled placeholder="Optional" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px; min-height: 50px; font-size: 12px;"></textarea>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Page 10: Free practice (same mock panels as page 9, no tour) -->
        <div class="tutorial-page" id="page10">
            <h2>Practice</h2>
            <span class="practice-label">PRACTICE</span>
            <p style="line-height: 1.8; margin-bottom: 15px;">Before starting the evaluation, practice it, one more time.</p>
            <div class="mock-three-panel" style="min-height: 550px;">
                <!-- Left: NFRs Display -->
                <div class="mock-panel" id="practice-nfr-panel">
                    <div class="mock-panel-header">
                        NFRs Display
                        <div class="mock-buttons">
                            <button class="mock-btn" type="button">ğŸ“‹ Code Structure</button>
                            <button class="mock-btn" type="button" onclick="openTutorialModal()">ğŸ“– Tutorial</button>
                        </div>
                    </div>
                    <div class="mock-panel-content">
                        <div class="mock-batch-info" style="padding: 10px; background: #e9ecef; border-radius: 4px; margin-bottom: 15px; font-weight: 600; display: flex; justify-content: space-between; align-items: center;">
                            Batch 1 of 1
                            <button class="mock-btn" type="button" id="practice-copy-btn" style="background: #007bff; color: white; border: none; padding: 6px 12px; font-size: 12px;">ğŸ“‹ Copy All NFRs</button>
                        </div>
                        <div id="practice-nfr-boxes">
                            <div class="mock-nfr-item">
                                <h4>NFR 1: Password Security</h4>
                                <p>The system must allow users to change passwords using secure storage methods</p>
                                <label class="mock-checkbox-label" style="margin-top: 10px;">
                                    <input type="checkbox" id="practice-nfr-cb-1">
                                    I have read and understood this NFR
                                </label>
                            </div>
                            <div class="mock-nfr-item">
                                <h4>NFR 2: Performance</h4>
                                <p>The system must load patient records within 2 seconds.</p>
                                <label class="mock-checkbox-label" style="margin-top: 10px;">
                                    <input type="checkbox" id="practice-nfr-cb-2">
                                    I have read and understood this NFR
                                </label>
                            </div>
                            <div class="mock-nfr-item">
                                <h4>NFR 3: Usability</h4>
                                <p>The interface must be accessible to users with visual impairments.</p>
                                <label class="mock-checkbox-label" style="margin-top: 10px;">
                                    <input type="checkbox" id="practice-nfr-cb-3">
                                    I have read and understood this NFR
                                </label>
                            </div>
                        </div>
                        <div id="practice-nfr-error" style="display: none; color: #c00; font-size: 13px; margin-top: 10px; font-weight: 600;">Please check all three NFR acknowledgement boxes.</div>
                    </div>
                </div>
                <!-- Middle: Chatbot -->
                <div class="mock-panel" id="practice-chat-panel">
                    <div class="mock-panel-header">Chatbot Assistant</div>
                    <div class="mock-chat-messages" id="practice-chat-messages"></div>
                    <div class="mock-chat-input" id="practice-chat-input-area" style="flex-wrap: wrap;">
                        <textarea id="practice-chat-input" placeholder="Type your messageâ€¦" rows="3" style="flex: 1; min-height: 60px; resize: vertical; padding: 8px; border: 1px solid #ddd; border-radius: 4px; font-size: 12px; font-family: inherit;"></textarea>
                        <button class="btn" id="practice-chat-send">Send</button>
                        <div id="practice-chat-error" style="display: none; color: #c00; font-size: 12px; margin-top: 6px; width: 100%; flex-basis: 100%;"></div>
                    </div>
                </div>
                <!-- Right: Feedback Form -->
                <div class="mock-panel" id="practice-feedback-form">
                    <div class="mock-panel-header">Feedback Form</div>
                    <div class="mock-panel-content white-bg">
                        <div id="practice-feedback-error" style="display: none; color: #c00; font-size: 13px; margin-bottom: 10px; font-weight: 600;">Please answer all three questions for NFR 1.</div>
                        <div class="mock-form-section">
                            <h4>NFR 1: Password Security</h4>
                            <div class="mock-form-group">
                                <label>Question 1: Based on the conversations, do you agree with the chatbot's satisfaction level assessment?<span style="color: #c00;">*</span></label>
                                <div class="mock-radio-group">
                                    <label><input type="radio" name="practice_q1_1" value="agree"> Agree</label>
                                    <label><input type="radio" name="practice_q1_1" value="partially_agree"> Partially agree</label>
                                    <label><input type="radio" name="practice_q1_1" value="partially_disagree"> Partially disagree</label>
                                    <label><input type="radio" name="practice_q1_1" value="disagree"> Disagree</label>
                                </div>
                            </div>
                            <div class="mock-form-group">
                                <label>Question 2: Based on the conversations, do you agree with the chatbot's reasoning?<span style="color: #c00;">*</span></label>
                                <div class="mock-radio-group">
                                    <label><input type="radio" name="practice_q2_1" value="agree"> Agree</label>
                                    <label><input type="radio" name="practice_q2_1" value="partially_agree"> Partially agree</label>
                                    <label><input type="radio" name="practice_q2_1" value="partially_disagree"> Partially disagree</label>
                                    <label><input type="radio" name="practice_q2_1" value="disagree"> Disagree</label>
                                </div>
                            </div>
                            <div class="mock-form-group">
                                <label>Question 3: Based on the conversations, do you agree with the chatbot's identified code locations?<span style="color: #c00;">*</span></label>
                                <div class="mock-radio-group">
                                    <label><input type="radio" name="practice_q3_1" value="agree"> Agree</label>
                                    <label><input type="radio" name="practice_q3_1" value="partially_agree"> Partially agree</label>
                                    <label><input type="radio" name="practice_q3_1" value="partially_disagree"> Partially disagree</label>
                                    <label><input type="radio" name="practice_q3_1" value="disagree"> Disagree</label>
                                </div>
                            </div>
                            <div class="mock-form-group">
                                <label>Undecided? Explain why:</label>
                                <textarea id="practice-feedback-optional" placeholder="Optional" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px; min-height: 50px; font-size: 12px;"></textarea>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="navigation">
            <button class="btn btn-secondary" id="prevBtn" onclick="changePage(-1)" style="display: none;">Previous</button>
            <button class="btn" id="nextBtn" onclick="changePage(1)">Next</button>
            <div id="tourCompleteError" style="display: none; color: #c00; font-weight: 600; margin-top: 8px;">Please complete the tour to proceed.</div>
            <div id="practiceCompleteError" style="display: none; color: #c00; font-weight: 600; margin-top: 8px;"></div>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/intro.js@7.2.0/minified/intro.min.js"></script>
<script>
const STATIC_PASSWORD = 'perc2026'; // Static password
let currentPage = 1;
const totalPages = 10;
let uuid = null;

// Get UUID from localStorage (should already exist from consent page)
window.addEventListener('load', () => {
    // Check if should redirect
    if (redirectToCorrectPage()) return;
    
    // Get UUID from localStorage - it should already exist from consent
    uuid = localStorage.getItem('chatbot_uuid');
    if (uuid) {
        // Validate UUID with server
        fetch('/api/get_or_create_uuid', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({uuid: uuid})
        })
        .then(r => r.json())
        .then(data => {
            uuid = data.uuid;
            localStorage.setItem('chatbot_uuid', uuid);
            setCurrentProgress(PROGRESS_STEPS.TUTORIAL, {page: currentPage});
            loadProgress();
        });
    } else {
        // UUID should exist - if not, redirect back to consent
        console.warn('No UUID found, redirecting to consent');
        window.location.href = '/';
    }
    
    // Check if modal should be opened
    const urlParams = new URLSearchParams(window.location.search);
    if (urlParams.get('modal') === 'true') {
        setTimeout(() => openTutorialModal(), 500);
    }
});


function loadProgress() {
    // Load page progress from localStorage
    const savedPage = localStorage.getItem('tutorial_page');
    if (savedPage) {
        currentPage = parseInt(savedPage);
        showPage(currentPage);
    } else {
        showPage(currentPage);
    }
}

var practicePage10Inited = false;
window._practiceChatMessageCount = 0;

var practiceBotReply1 = 'Example of a good first message:\nPlease evaluate the following NFR. Provide:\nâ€¢ Level of satisfaction\nâ€¢ Reasoning\nâ€¢ Relevant code locations (if applicable).\n\nNFR1: The system must allow users to change passwords using secure storage methods\nNFR2: The system must load patient records within 2 seconds.\nNFR3: The interface must be accessible to users with visual impairments.';

var practiceBotReply2 = 'Your dialogue should include:\n\nâ€¢ Asking clarifying questions about unclear requirements\nâ€¢ Seeking additional information about implementation details\nâ€¢ Requesting specific code locations or examples\nâ€¢ Discussing potential approaches to satisfy the requirements\nâ€¢ Providing context about the system architecture when needed\nâ€¢ Challenging or validating the chatbot\'s assessments';

var practiceBotReply3 = 'The chatbot should evaluate each NFR on three dimensions:\n\nâ€¢ Satisfaction Level: Satisfied, Weakly Satisfied, Weakly Denied, Denied, or Not Applicable\nâ€¢ Reasoning: Explanation for the satisfaction level\nâ€¢ Code Locations: Specific places in the code where the NFR is addressed';

var practiceBotReplyProceed = 'You can proceed to the feedback form.';

function getPracticeChatMessageCount() {
    var messages = document.getElementById('practice-chat-messages');
    if (!messages) return 0;
    return messages.querySelectorAll('.mock-message.user').length;
}

function initPracticePage10() {
    if (practicePage10Inited) return;
    practicePage10Inited = true;
    var practiceCopyNfrText = 'NFR 1:The system must allow users to change passwords using secure storage methods\nNFR2: The system must load patient records within 2 seconds.\nNFR3: The interface must be accessible to users with visual impairments.';
    var copyBtn = document.getElementById('practice-copy-btn');
    if (copyBtn) {
        copyBtn.addEventListener('click', function() {
            if (navigator.clipboard && navigator.clipboard.writeText) {
                navigator.clipboard.writeText(practiceCopyNfrText).catch(function() {
                    var ta = document.createElement('textarea');
                    ta.value = practiceCopyNfrText;
                    ta.style.position = 'fixed';
                    ta.style.left = '-9999px';
                    document.body.appendChild(ta);
                    ta.select();
                    try { document.execCommand('copy'); } finally { document.body.removeChild(ta); }
                });
            } else {
                var ta = document.createElement('textarea');
                ta.value = practiceCopyNfrText;
                ta.style.position = 'fixed';
                ta.style.left = '-9999px';
                document.body.appendChild(ta);
                ta.select();
                try { document.execCommand('copy'); } finally { document.body.removeChild(ta); }
            }
        });
    }
    var sendBtn = document.getElementById('practice-chat-send');
    var chatInput = document.getElementById('practice-chat-input');
    var chatMessages = document.getElementById('practice-chat-messages');
    var chatErr = document.getElementById('practice-chat-error');
    if (sendBtn && chatInput && chatMessages) {
        sendBtn.addEventListener('click', function() {
            var text = (chatInput.value || '').trim();
            if (!text) return;
            if (chatErr) { chatErr.style.display = 'none'; chatErr.textContent = ''; }
            if (!practiceNfrBoxesChecked()) {
                if (chatErr) { chatErr.style.display = 'block'; chatErr.textContent = 'Please check all NFR boxes first.'; }
                return;
            }
            // Check if this is the first message - if so, show all three bot replies
            var isFirstMessage = getPracticeChatMessageCount() === 0;
            
            // Add user message
            var userWrap = document.createElement('div');
            userWrap.className = 'mock-message user';
            var userContent = document.createElement('div');
            userContent.className = 'mock-message-content';
            userContent.style.whiteSpace = 'pre-wrap';
            userContent.textContent = text;
            userWrap.appendChild(userContent);
            chatMessages.appendChild(userWrap);
            
            // If first message, show all three bot replies
            if (isFirstMessage) {
                // Show first bot reply
                var botWrap1 = document.createElement('div');
                botWrap1.className = 'mock-message bot';
                var botContent1 = document.createElement('div');
                botContent1.className = 'mock-message-content';
                botContent1.style.whiteSpace = 'pre-wrap';
                botContent1.textContent = practiceBotReply1;
                botWrap1.appendChild(botContent1);
                chatMessages.appendChild(botWrap1);
                
                // Show second bot reply
                var botWrap2 = document.createElement('div');
                botWrap2.className = 'mock-message bot';
                var botContent2 = document.createElement('div');
                botContent2.className = 'mock-message-content';
                botContent2.style.whiteSpace = 'pre-wrap';
                botContent2.textContent = practiceBotReply2;
                botWrap2.appendChild(botContent2);
                chatMessages.appendChild(botWrap2);
                
                // Show third bot reply
                var botWrap3 = document.createElement('div');
                botWrap3.className = 'mock-message bot';
                var botContent3 = document.createElement('div');
                botContent3.className = 'mock-message-content';
                botContent3.style.whiteSpace = 'pre-wrap';
                botContent3.textContent = practiceBotReply3;
                botWrap3.appendChild(botContent3);
                chatMessages.appendChild(botWrap3);
                
                // Disable chat input after first message
                if (chatInput) chatInput.disabled = true;
                if (sendBtn) sendBtn.disabled = true;
            }
            
            chatInput.value = '';
            chatMessages.scrollTop = chatMessages.scrollHeight;
            window._practiceChatMessageCount = getPracticeChatMessageCount();
        });
    }
}

function practiceNfrBoxesChecked() {
    var c1 = document.getElementById('practice-nfr-cb-1');
    var c2 = document.getElementById('practice-nfr-cb-2');
    var c3 = document.getElementById('practice-nfr-cb-3');
    return c1 && c2 && c3 && c1.checked && c2.checked && c3.checked;
}

function practiceGateFilled() {
    // Gate textarea removed - always return true
    return true;
}

function practiceFeedbackCompleted() {
    var q1 = document.querySelector('input[name="practice_q1_1"]:checked');
    var q2 = document.querySelector('input[name="practice_q2_1"]:checked');
    var q3 = document.querySelector('input[name="practice_q3_1"]:checked');
    return q1 && q2 && q3;
}

function showPage(page) {
    // Hide all pages
    for (let i = 1; i <= totalPages; i++) {
        document.getElementById(`page${i}`).classList.remove('active');
    }
    
    // Show current page
    document.getElementById(`page${page}`).classList.add('active');
    document.getElementById('pageNum').textContent = page;
    var tourCompleteErr = document.getElementById('tourCompleteError');
    var practiceCompleteErr = document.getElementById('practiceCompleteError');
    if (tourCompleteErr) tourCompleteErr.style.display = 'none';
    if (practiceCompleteErr) { practiceCompleteErr.style.display = 'none'; practiceCompleteErr.textContent = ''; }
    document.getElementById('totalPages').textContent = totalPages;
    
    // Update navigation buttons
    document.getElementById('prevBtn').style.display = page === 1 ? 'none' : 'block';
    document.getElementById('nextBtn').textContent = page === totalPages ? 'Start Evaluation' : 'Next';
    
    // Wide container for page 9 (tour) and page 10 (free practice)
    const container = document.querySelector('.tutorial-container');
    if (container) {
        if (page === 9 || page === 10) container.classList.add('wide');
        else container.classList.remove('wide');
    }
    
    // Page 10: set up Copy button and mock chat (once per page load), hide practice errors
    if (page === 10) {
        initPracticePage10();
        // Reset chat input state when page is shown (only if no messages sent yet)
        var chatInput = document.getElementById('practice-chat-input');
        var sendBtn = document.getElementById('practice-chat-send');
        var chatCount = getPracticeChatMessageCount();
        if (chatInput) chatInput.disabled = chatCount > 0;
        if (sendBtn) sendBtn.disabled = chatCount > 0;
        ['practice-nfr-error', 'practice-chat-error', 'practice-feedback-error'].forEach(function(id) {
            var el = document.getElementById(id);
            if (el) { el.style.display = 'none'; if (el.textContent) el.textContent = ''; }
        });
    }
    
    // Intro.js tour on page 9 (evaluation replica walkthrough)
    if (page === 9 && typeof introJs !== 'undefined') {
        setTimeout(function() {
            function allTourBoxesChecked() {
                var c1 = document.getElementById('tour-nfr-cb-1');
                var c2 = document.getElementById('tour-nfr-cb-2');
                var c3 = document.getElementById('tour-nfr-cb-3');
                return c1 && c2 && c3 && c1.checked && c2.checked && c3.checked;
            }
            function tryAdvanceFromCheckboxes() {
                var errEl = document.getElementById('tour-nfr-error');
                if (errEl) errEl.style.display = 'none';
                if (allTourBoxesChecked() && window._page10Tour && window._page10TourCurrentStep === 2) {
                    window._page10Tour.nextStep();
                }
            }
            function gateAnswerFilled() {
                // Gate textarea removed - always return true
                return true;
            }
            function feedbackFormChecked() {
                var q1 = document.querySelector('input[name="demo_q1_1"]:checked');
                var q2 = document.querySelector('input[name="demo_q2_1"]:checked');
                var q3 = document.querySelector('input[name="demo_q3_1"]:checked');
                return q1 && q2 && q3;
            }
            window.resetPage10Tour = function() {
                if (window._page10Tour) {
                    try { window._page10Tour.exit(); } catch (e) {}
                }
                window._page10Tour = null;
                window._tourCompleted = false;
                window._tourChatSent = false;
                window._tourFollowUpAdded = false;
                ['tour-nfr-cb-1', 'tour-nfr-cb-2', 'tour-nfr-cb-3'].forEach(function(id) {
                    var el = document.getElementById(id);
                    if (el) { el.checked = false; el._tourListener = false; }
                });
                var chatInput = document.getElementById('tour-chat-input');
                if (chatInput) chatInput.value = '';
                var messagesEl = document.getElementById('tour-chat-messages');
                if (messagesEl) {
                    while (messagesEl.firstChild) messagesEl.removeChild(messagesEl.firstChild);
                    var firstMsg = document.createElement('div');
                    firstMsg.id = 'tour-chat-first-message';
                    firstMsg.className = 'mock-message user';
                    firstMsg.style.display = 'none';
                    var content = document.createElement('div');
                    content.className = 'mock-message-content';
                    content.style.whiteSpace = 'pre-wrap';
                    content.style.textAlign = 'left';
                    firstMsg.appendChild(content);
                    messagesEl.appendChild(firstMsg);
                }
                ['tour-nfr-error', 'tour-chat-error', 'tourCompleteError', 'tour-feedback-error'].forEach(function(id) {
                    var el = document.getElementById(id);
                    if (el) el.style.display = 'none';
                });
                ['demo_q1_1', 'demo_q2_1', 'demo_q3_1'].forEach(function(name) {
                    var radios = document.querySelectorAll('input[name="' + name + '"]');
                    for (var i = 0; i < radios.length; i++) radios[i].checked = false;
                });
            };
            var tourChatFirstMessageText = [
                'Please evaluate the following NFR. Provide:',
                'â€¢ Level of satisfaction',
                'â€¢ Reasoning',
                'â€¢ Relevant code locations (if applicable).',
                '',
                'NFR1: The system must allow users to change passwords using secure storage methods',
                'NFR2: The system must load patient records within 2 seconds.',
                'NFR3: The interface must be accessible to users with visual impairments.'
            ].join('\n');
            var tourChatBotText = [
                'NFR 1: Secure password storage',
                'Level of satisfaction: Satisfied',
                'Reasoning: Passwords are hashed with SHA-256 and a per-user salt before storage. The resetPassword method in AuthDAO uses DigestUtils.sha256Hex() and stores salt in the database.',
                'Relevant code locations: AuthDAO.java (resetPassword), ChangePasswordAction.java',
                '',
                'NFR 2: Load patient records within 2 seconds',
                'Level of satisfaction: Weakly Denied',
                'Reasoning: ...',
                'Relevant code locations: ...',
                '',
                'NFR 3: Accessibility for users with visual impairments',
                'Level of satisfaction: Weakly Satisfied',
                'Reasoning: ...',
                'Relevant code locations: ...'
            ].join('\n');
            var tourFollowUpUserText = 'For NFR 1, you mentioned that SHA-256 is being used for password hashing. Isn\'t SHA-256 vulnerable to brute-force attacks?';
            var tourFollowUpBotText = 'You\'re right. So it is Weakly Satisfied. The system does use salted hashing (which is better than plain storage), but it falls short of modern best practices like bcrypt or Argon2.';
            window.startPage10Tour = function() {
                window._tourChatSent = false;
                window._tourCompleted = false;
                const tour = introJs();
            tour.setOptions({
                steps: [
                    {
                        element: document.getElementById('tour-tutorial-buttons'),
                        intro: 'You can review this tutorial at any time.',
                        position: 'bottom'
                    },
                    {
                        element: document.getElementById('tour-nfr-boxes'),
                        intro: 'Review and understand the NFRs.',
                        position: 'right'
                    },
                    {
                        element: document.getElementById('tour-nfr-boxes'),
                        intro: 'After you read them, press the acknowledgement box for each NFR.',
                        position: 'right'
                    },
                    {
                        element: document.getElementById('tour-copy-btn'),
                        intro: 'Copy all NFRs.',
                        position: 'bottom'
                    },
                    {
                        element: document.getElementById('tour-chat-panel'),
                        intro: '<strong>Interact with the chatbot to get the following for each NFR:</strong><ul style="margin: 10px 0 0 18px; padding-left: 8px;"><li>Satisfaction Level (Satisfied, Weakly Satisfied, Weakly Denied, Denied, or Not Applicable)</li><li>Reasoning for that level</li><li>Specific Code Locations that address the NFR</li></ul>',
                        position: 'left'
                    },
                    {
                        element: document.getElementById('tour-chat-input-area'),
                        intro: '<strong>Start by first asking all NFRs together.</strong><br><br>Example: Please evaluate the following NFR. Provide:<br>Level of satisfaction<br>Reasoning<br>Relevant code locations (if applicable)<br><br>NFR1: ... NFR2: ... NFR3: ...<br><br>Write your message and press Send to continue.',
                        position: 'left'
                    },
                    {
                        element: document.getElementById('tour-chat-first-message'),
                        intro: 'Example of good first message.',
                        position: 'left'
                    },
                    {
                        element: document.getElementById('tour-chat-input-area'),
                        intro: '<strong>Engage with the chatbot as a developer would when working to evaluate requirements.</strong> Your follow-ups should include:<ul style="margin: 10px 0 0 18px; padding-left: 8px;"><li>Asking clarifying questions about unclear requirements</li><li>Seeking additional information about implementation details</li><li>Requesting specific code locations or examples</li><li>Discussing potential approaches to satisfy the requirements</li><li>Providing context about the system architecture when needed</li><li>Challenging or validating the chatbot\'s assessments</li></ul>',
                        position: 'left'
                    },
                    {
                        element: document.getElementById('tour-chat-panel'),
                        intro: 'Example of a follow-up dialogue.',
                        position: 'left'
                    },
                    {
                        element: document.getElementById('tour-feedback-form'),
                        intro: 'Once you\'re convinced the chatbot has fully assessed the NFRs, complete this feedback form for each NFR. Answer all three questions for NFR 1 below, then click Next.',
                        position: 'left'
                    },
                    {
                        element: document.getElementById('tour-feedback-form'),
                        intro: 'Based on the fully assessed dialogues with the chatbot, do you agree with its evaluation? (The code is provided for reference only â€” you do not need to verify it.)',
                        position: 'left'
                    }
                ],
                exitOnOverlayClick: true,
                showStepNumbers: true,
                showBullets: true,
                showProgress: true
            });
            tour.onbeforechange(function() {
                var current = this._currentStep;
                var nfrErr = document.getElementById('tour-nfr-error');
                var chatErr = document.getElementById('tour-chat-error');
                var feedbackErr = document.getElementById('tour-feedback-error');
                if (nfrErr) nfrErr.style.display = 'none';
                if (chatErr) chatErr.style.display = 'none';
                if (feedbackErr) feedbackErr.style.display = 'none';
                // Step 3 (index 3): block until all acknowledgement boxes are checked.
                if (current === 3 && !allTourBoxesChecked()) {
                    if (nfrErr) nfrErr.style.display = 'block';
                    return false;
                }
                // Step 6 (index 6): block until they wrote in chat and pressed Send.
                if (current === 6 && !window._tourChatSent) {
                    if (chatErr) chatErr.style.display = 'block';
                    return false;
                }
                // Step 10 (feedback form): block only when leaving step 10 to go to step 11 ("All set").
                // So we validate when the *next* step would be 10 (0-based) â€” i.e. we're on the feedback step and pressed Next.
                if (current === 10 && !feedbackFormChecked()) {
                    if (feedbackErr) feedbackErr.style.display = 'block';
                    return false;
                }
                return true;
            });
            tour.onchange(function() {
                window._page10TourCurrentStep = this._currentStep;
                var nfrErr = document.getElementById('tour-nfr-error');
                var feedbackErr = document.getElementById('tour-feedback-error');
                if (nfrErr) nfrErr.style.display = 'none';
                if (feedbackErr) feedbackErr.style.display = 'none';
                if (this._currentStep === 10) {
                    window._tourCompleted = true;
                    var tourCompleteErr = document.getElementById('tourCompleteError');
                    if (tourCompleteErr) tourCompleteErr.style.display = 'none';
                }
                if (this._currentStep === 8 && !window._tourFollowUpAdded) {
                    window._tourFollowUpAdded = true;
                    var messagesEl = document.getElementById('tour-chat-messages');
                    if (messagesEl) {
                        while (messagesEl.firstChild) {
                            messagesEl.removeChild(messagesEl.firstChild);
                        }
                        var userWrap = document.createElement('div');
                        userWrap.id = 'tour-follow-up-user-message';
                        userWrap.className = 'mock-message user';
                        var userContent = document.createElement('div');
                        userContent.className = 'mock-message-content';
                        userContent.style.whiteSpace = 'pre-wrap';
                        userContent.textContent = tourFollowUpUserText;
                        userWrap.appendChild(userContent);
                        messagesEl.appendChild(userWrap);
                        var botWrap = document.createElement('div');
                        botWrap.className = 'mock-message bot';
                        var botContent = document.createElement('div');
                        botContent.className = 'mock-message-content';
                        botContent.style.whiteSpace = 'pre-wrap';
                        botContent.textContent = tourFollowUpBotText;
                        botWrap.appendChild(botContent);
                        messagesEl.appendChild(botWrap);
                    }
                }
                if (this._currentStep === 2) {
                    ['tour-nfr-cb-1', 'tour-nfr-cb-2', 'tour-nfr-cb-3'].forEach(function(id) {
                        var el = document.getElementById(id);
                        if (el && !el._tourListener) {
                            el._tourListener = true;
                            el.addEventListener('change', tryAdvanceFromCheckboxes);
                        }
                    });
                }
            });
            tour.onexit(function() {
                ['tour-nfr-cb-1', 'tour-nfr-cb-2', 'tour-nfr-cb-3'].forEach(function(id) {
                    var el = document.getElementById(id);
                    if (el && el._tourListener) {
                        el.removeEventListener('change', tryAdvanceFromCheckboxes);
                        el._tourListener = false;
                    }
                });
                var nfrErr = document.getElementById('tour-nfr-error');
                var chatErr = document.getElementById('tour-chat-error');
                var feedbackErr = document.getElementById('tour-feedback-error');
                if (nfrErr) nfrErr.style.display = 'none';
                if (chatErr) chatErr.style.display = 'none';
                if (feedbackErr) feedbackErr.style.display = 'none';
                window._page10Tour = null;
                window._tourFollowUpAdded = false;
            });
            window._page10Tour = tour;
            window._page10TourCurrentStep = 1;
            tour.start();
            };
            var tourCopyNfrText = 'NFR 1:The system must allow users to change passwords using secure storage methods\nNFR2: The system must load patient records within 2 seconds.\nNFR3: The interface must be accessible to users with visual impairments.';
            var copyBtn = document.getElementById('tour-copy-btn');
            if (copyBtn && !copyBtn._copyListener) {
                copyBtn._copyListener = true;
                copyBtn.addEventListener('click', function() {
                    if (navigator.clipboard && navigator.clipboard.writeText) {
                        navigator.clipboard.writeText(tourCopyNfrText).catch(function() {
                            fallbackCopyToClipboard(tourCopyNfrText);
                        });
                    } else {
                        fallbackCopyToClipboard(tourCopyNfrText);
                    }
                });
            }
            function fallbackCopyToClipboard(text) {
                var ta = document.createElement('textarea');
                ta.value = text;
                ta.style.position = 'fixed';
                ta.style.left = '-9999px';
                document.body.appendChild(ta);
                ta.select();
                try {
                    document.execCommand('copy');
                } finally {
                    document.body.removeChild(ta);
                }
            }
            var sendBtn = document.getElementById('tour-chat-send');
            if (sendBtn && !sendBtn._sendListenerAdded) {
                sendBtn._sendListenerAdded = true;
                sendBtn.addEventListener('click', function() {
                    var input = document.getElementById('tour-chat-input');
                    var text = (input && input.value) ? input.value.trim() : '';
                    if (!text) {
                        var chatErr = document.getElementById('tour-chat-error');
                        if (chatErr) chatErr.style.display = 'block';
                        return;
                    }
                    var firstMsg = document.getElementById('tour-chat-first-message');
                    var contentEl = firstMsg ? firstMsg.querySelector('.mock-message-content') : null;
                    if (contentEl) {
                        contentEl.textContent = tourChatFirstMessageText;
                        firstMsg.style.display = 'block';
                    }
                    var messagesEl = document.getElementById('tour-chat-messages');
                    if (messagesEl && tourChatBotText) {
                        var botWrap = document.createElement('div');
                        botWrap.className = 'mock-message bot';
                        var botContent = document.createElement('div');
                        botContent.className = 'mock-message-content';
                        botContent.style.whiteSpace = 'pre-wrap';
                        botContent.textContent = tourChatBotText;
                        botWrap.appendChild(botContent);
                        messagesEl.appendChild(botWrap);
                    }
                    if (input) input.value = '';
                    var chatErr = document.getElementById('tour-chat-error');
                    if (chatErr) chatErr.style.display = 'none';
                    window._tourChatSent = true;
                    console.log('window._page10TourCurrentStep:', window._page10TourCurrentStep);
                    if (window._page10Tour && window._page10TourCurrentStep === 5) {
                        window._page10Tour.nextStep();
                    }
                });
            }
            var redoBtn = document.getElementById('tour-redo-btn');
            if (redoBtn) {
                redoBtn.addEventListener('click', function() {
                    window.resetPage10Tour();
                    window.startPage10Tour();
                });
            }
            window.startPage10Tour();
        }, 400);
    }
}

function changePage(direction) {
    if (direction === 1) {
        // Validate current page before proceeding
        if (currentPage === 4) {
            // Validate password
            const password = document.getElementById('password').value;
            if (password !== STATIC_PASSWORD) {
                document.getElementById('passwordError').style.display = 'block';
                return;
            }
        }
        
        // Validate page 6 - view layer quiz (changePassword)
        if (currentPage === 6) {
            const successEl = document.getElementById('viewLayerSuccess');
            if (successEl.style.display === 'block') {
                // Already passed - allow proceeding
            } else {
                const answer = document.getElementById('viewLayerAnswer').value.trim().toLowerCase().replace(/\s/g, '');
                const correctAnswer = 'changepassword';
                if (answer !== correctAnswer) {
                    document.getElementById('viewLayerError').style.display = 'block';
                    return;
                }
                document.getElementById('viewLayerError').style.display = 'none';
                successEl.style.display = 'block';
                return; // Stay on page to show image; user clicks Next again to proceed
            }
        }
        
        // Validate page 7 - controller layer quiz (ChangePasswordAction)
        if (currentPage === 7) {
            const successEl = document.getElementById('controllerLayerSuccess');
            if (successEl.style.display === 'block') {
                // Already passed - allow proceeding
            } else {
                const answer = document.getElementById('controllerLayerAnswer').value.trim().replace(/\s/g, '');
                const correctAnswer = 'ChangePasswordAction';
                if (answer !== correctAnswer && answer.toLowerCase() !== 'changepasswordaction') {
                    document.getElementById('controllerLayerError').style.display = 'block';
                    return;
                }
                document.getElementById('controllerLayerError').style.display = 'none';
                successEl.style.display = 'block';
                return;
            }
        }
        
        // Validate page 8 - model layer quiz (AuthDAO)
        if (currentPage === 8) {
            const successEl = document.getElementById('modelLayerSuccess');
            if (successEl.style.display === 'block') {
                // Already passed - allow proceeding
            } else {
                const answer = document.getElementById('modelLayerAnswer').value.trim().replace(/\s/g, '');
                const correctAnswer = 'AuthDAO';
                if (answer !== correctAnswer && answer.toLowerCase() !== 'authdao') {
                    document.getElementById('modelLayerError').style.display = 'block';
                    return;
                }
                document.getElementById('modelLayerError').style.display = 'none';
                successEl.style.display = 'block';
                return;
            }
        }
        
        // Validate page 9 - tour must be completed to go to evaluation
        if (currentPage === 9 && !window._tourCompleted) {
            const tourCompleteErr = document.getElementById('tourCompleteError');
            if (tourCompleteErr) tourCompleteErr.style.display = 'block';
            return;
        }
        
        // Validate page 10 - practice must be completed before Start Evaluation (show first incomplete step, like step 9)
        if (currentPage === 10) {
            var practiceCompleteErr = document.getElementById('practiceCompleteError');
            if (practiceCompleteErr) { practiceCompleteErr.style.display = 'none'; practiceCompleteErr.textContent = ''; }
            if (!practiceNfrBoxesChecked()) {
                if (practiceCompleteErr) { practiceCompleteErr.textContent = 'Please check all three NFR acknowledgement boxes.'; practiceCompleteErr.style.display = 'block'; }
                return;
            }
            var chatCount = getPracticeChatMessageCount();
            if (chatCount < 1) {
                if (practiceCompleteErr) {
                    practiceCompleteErr.textContent = 'Interact with the chatbot.';
                    practiceCompleteErr.style.display = 'block';
                }
                return;
            }
            if (!practiceFeedbackCompleted()) {
                if (practiceCompleteErr) { practiceCompleteErr.textContent = 'Please answer all three questions in the feedback form.'; practiceCompleteErr.style.display = 'block'; }
                return;
            }
        }
        
        if (currentPage === totalPages) {
            // Save progress and go to evaluation
            localStorage.setItem('tutorial_page', currentPage.toString());
            setCurrentProgress(PROGRESS_STEPS.EVALUATION, {batch: 1});
            window.location.href = '/evaluation?batch=1';
            return;
        }
        currentPage++;
    } else {
        currentPage--;
    }
    
    showPage(currentPage);
    // Save page progress to localStorage
    localStorage.setItem('tutorial_page', currentPage.toString());
    setCurrentProgress(PROGRESS_STEPS.TUTORIAL, {page: currentPage});
}

// Check if all mock NFR checkboxes are checked
function checkMockNfrBoxes() {
    const cb1 = document.getElementById('mock_nfr_read_1');
    const cb2 = document.getElementById('mock_nfr_read_2');
    const cb3 = document.getElementById('mock_nfr_read_3');
    
    if (!cb1 || !cb2 || !cb3) return false;
    
    const allChecked = cb1.checked && cb2.checked && cb3.checked;
    
    // Update visual feedback
    if (allChecked) {
        document.getElementById('mockGateError').style.display = 'none';
    }
    
    return allChecked;
}

showPage(currentPage);
</script>
{% endblock %}
