{% extends "base.html" %}

{% block title %}Consent Form{% endblock %}

{% block extra_css %}
<style>
    .consent-content {
        line-height: 1.8;
    }
    .consent-content ul, 
    .consent-content ol {
        margin: 15px 0;
        padding-left: 40px;
        display: block;
    }
    .consent-content li {
        margin: 8px 0;
        display: list-item;
        list-style-position: outside;
    }
    .consent-content ul {
        list-style-type: disc;
    }
    .consent-content ul li {
        list-style-type: disc;
    }
    .consent-content ol {
        list-style-type: decimal;
    }
    .consent-content ol li {
        list-style-type: decimal;
    }
    .consent-content p {
        margin: 15px 0;
    }
    .consent-content strong {
        font-weight: 600;
    }
    .consent-content h1, 
    .consent-content h2, 
    .consent-content h3 {
        margin: 20px 0 10px 0;
        font-weight: 600;
    }
</style>
{% endblock %}

{% block content %}
<div class="container">
    <div style="max-width: 800px; margin: 40px auto; background: white; padding: 40px; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.1);">
        <h1 style="margin-bottom: 30px; color: #333;">Consent Form</h1>
        
        <div class="consent-content" style="margin-bottom: 30px; line-height: 1.8;">
            {% if consent_html %}
                {{ consent_html|safe }}
            {% else %}
                <p>Loading consent form...</p>
            {% endif %}
        </div>
        
        <div style="margin-top: 40px; display: flex; gap: 20px; justify-content: center;">
            <button id="agreeBtn" class="btn" onclick="agreeToConsent()">I Agree</button>
            <button class="btn btn-secondary" onclick="window.location.href='/'">Cancel</button>
        </div>
    </div>
</div>

<script>
// Check progress on page load
window.addEventListener('load', () => {
    redirectToCorrectPage();
});

function agreeToConsent() {
    // Get the button element
    const agreeBtn = document.getElementById('agreeBtn');
    const originalText = agreeBtn.textContent;
    
    // Set loading state
    agreeBtn.disabled = true;
    agreeBtn.textContent = 'Loading...';
    
    // Check if UUID already exists in localStorage
    let uuid = localStorage.getItem('chatbot_uuid');
    
    const prolificPid = new URLSearchParams(window.location.search).get('PROLIFIC_PID');

    if (uuid) {
        // UUID exists, validate it and proceed
        const body = {uuid: uuid};
        if (prolificPid) body.prolific_pid = prolificPid;
        fetch('/api/get_or_create_uuid', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify(body)
        })
        .then(r => r.json())
        .then(data => {
            localStorage.setItem('chatbot_uuid', data.uuid);
            if (prolificPid) localStorage.setItem('prolific_pid', prolificPid);
            setCurrentProgress(PROGRESS_STEPS.TUTORIAL, {page: 1});
            window.location.href = '/tutorial?page=1';
        })
        .catch(error => {
            console.error('Error validating UUID:', error);
            // Reset button state on error
            agreeBtn.disabled = false;
            agreeBtn.textContent = originalText;
            alert('An error occurred. Please try again.');
        });
    } else {
        // Create new UUID when user agrees to consent
        const body = prolificPid ? {prolific_pid: prolificPid} : {};
        fetch('/api/get_or_create_uuid', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify(body)
        })
        .then(r => r.json())
        .then(data => {
            localStorage.setItem('chatbot_uuid', data.uuid);
            if (prolificPid) localStorage.setItem('prolific_pid', prolificPid);
            setCurrentProgress(PROGRESS_STEPS.TUTORIAL, {page: 1});
            window.location.href = '/tutorial?page=1';
        })
        .catch(error => {
            console.error('Error creating UUID:', error);
            agreeBtn.disabled = false;
            agreeBtn.textContent = originalText;
            alert('An error occurred. Please try again.');
        });
    }
}
</script>
{% endblock %}
