{% extends "base.html" %}

{% block title %}Evaluation{% endblock %}

{% block extra_css %}
<style>
    .evaluation-container {
        display: flex;
        height: calc(100vh - 40px);
        gap: 20px;
        margin: 20px;
    }
    .nfr-panel, .form-panel, .chatbot-panel {
        flex: 1;
        background: white;
        border-radius: 8px;
        box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        display: flex;
        flex-direction: column;
        overflow: hidden;
    }
    .panel-header {
        padding: 15px;
        background: #007bff;
        color: white;
        font-weight: 600;
        border-radius: 8px 8px 0 0;
        display: flex;
        justify-content: space-between;
        align-items: center;
    }
    .panel-content {
        flex: 1;
        padding: 20px;
        overflow-y: auto;
    }
    .batch-info {
        padding: 10px;
        background: #e9ecef;
        border-radius: 4px;
        margin-bottom: 15px;
        text-align: center;
        font-weight: 600;
        display: flex;
        justify-content: space-between;
        align-items: center;
    }
    .copy-nfrs-btn {
        padding: 6px 12px;
        background: #007bff;
        color: white;
        border: none;
        border-radius: 4px;
        cursor: pointer;
        font-size: 12px;
        transition: background 0.3s;
    }
    .copy-nfrs-btn:hover {
        background: #0056b3;
    }
    .nfr-item {
        margin-bottom: 20px;
        padding: 15px;
        background: #f8f9fa;
        border-radius: 4px;
        border-left: 4px solid #007bff;
    }
    .nfr-item h4 {
        margin-bottom: 8px;
        color: #333;
        font-size: 14px;
        font-weight: 600;
    }
    .nfr-item p {
        margin: 0;
        color: #666;
        font-size: 13px;
        line-height: 1.5;
    }
    .nfr-form-section {
        margin-bottom: 30px;
        padding: 15px;
        background: #f8f9fa;
        border-radius: 4px;
        border: 1px solid #ddd;
    }
    .nfr-form-section h4 {
        margin-bottom: 15px;
        color: #333;
        font-size: 14px;
    }
    .form-group {
        margin-bottom: 15px;
    }
    .form-group label {
        display: block;
        margin-bottom: 8px;
        font-weight: 600;
        font-size: 13px;
    }
    .form-group textarea {
        width: 100%;
        padding: 8px;
        border: 1px solid #ddd;
        border-radius: 4px;
        font-size: 13px;
        resize: vertical;
        min-height: 60px;
    }
    .radio-group {
        display: flex;
        gap: 10px;
        flex-wrap: wrap;
        margin-top: 5px;
    }
    .radio-group label {
        display: flex;
        align-items: center;
        font-weight: normal;
        cursor: pointer;
        font-size: 12px;
    }
    .radio-group input[type="radio"] {
        margin-right: 5px;
    }
    .chatbot-header {
        padding: 15px;
        background: #007bff;
        color: white;
        border-radius: 8px 8px 0 0;
        font-weight: 600;
    }
    .chatbot-messages {
        flex: 1;
        padding: 20px;
        overflow-y: auto;
        background: #f8f9fa;
    }
    .message {
        margin-bottom: 15px;
    }
    .message.user {
        text-align: right;
    }
    .message.bot {
        text-align: left;
    }
    .message-content {
        display: inline-block;
        padding: 10px 15px;
        border-radius: 18px;
        max-width: 80%;
        white-space: pre-wrap;
        word-wrap: break-word;
    }
    .message.user .message-content {
        background: #007bff;
        color: white;
    }
    .message.bot .message-content {
        background: white;
        color: #333;
        border: 1px solid #ddd;
    }
    .message-time {
        font-size: 11px;
        color: #666;
        margin-top: 5px;
    }
    .chatbot-input {
        padding: 15px;
        border-top: 1px solid #ddd;
        display: flex;
        gap: 10px;
    }
    .chatbot-input input,
    .chatbot-input textarea {
        flex: 1;
        padding: 10px;
        border: 1px solid #ddd;
        border-radius: 4px;
        font-family: inherit;
        font-size: 14px;
        resize: vertical;
        min-height: 40px;
        max-height: 150px;
    }
    .chatbot-input textarea {
        line-height: 1.5;
    }
    .chatbot-input button {
        padding: 10px 20px;
    }
    .submit-batch-btn {
        margin-top: 20px;
        width: 100%;
        padding: 12px;
        font-size: 16px;
    }
    .nfr-form-section.completed {
        border-color: #28a745;
        background: #d4edda;
    }
    .tutorial-btn {
        padding: 6px 12px;
        background: rgba(255, 255, 255, 0.2);
        color: white;
        border: 1px solid rgba(255, 255, 255, 0.3);
        border-radius: 4px;
        cursor: pointer;
        font-size: 12px;
        transition: background 0.3s;
    }
    .tutorial-btn:hover {
        background: rgba(255, 255, 255, 0.3);
    }
    .code-structure-modal {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        z-index: 10000;
        display: none;
        align-items: center;
        justify-content: center;
    }
    .code-structure-modal.active {
        display: flex;
    }
    .code-structure-modal-overlay {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.5);
        z-index: 10001;
    }
    .code-structure-modal-content {
        position: relative;
        background: white;
        border-radius: 8px;
        max-width: 1000px;
        max-height: 90vh;
        width: 90%;
        z-index: 10002;
        display: flex;
        flex-direction: column;
        box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
    }
    .code-structure-modal-header {
        padding: 20px;
        border-bottom: 1px solid #ddd;
        display: flex;
        justify-content: space-between;
        align-items: center;
        flex-shrink: 0;
    }
    .code-structure-modal-header h2 {
        margin: 0;
        color: #333;
    }
    .code-structure-modal-close {
        background: none;
        border: none;
        font-size: 32px;
        color: #666;
        cursor: pointer;
        padding: 0;
        width: 32px;
        height: 32px;
        line-height: 32px;
        text-align: center;
    }
    .code-structure-modal-close:hover {
        color: #333;
    }
    .code-structure-modal-body {
        padding: 30px;
        overflow-y: auto;
        flex: 1;
    }
    .code-structure-section {
        margin-bottom: 30px;
    }
    .code-structure-section h3 {
        margin-top: 0;
        margin-bottom: 15px;
        color: #007bff;
        font-size: 20px;
    }
    .code-structure-section p {
        margin-bottom: 15px;
        line-height: 1.8;
    }
    .code-structure-section ol {
        margin-left: 20px;
        line-height: 2;
        margin-bottom: 30px;
    }
    .code-structure-section pre {
        background: #f5f5f5;
        padding: 20px;
        border-radius: 4px;
        overflow-x: auto;
        font-size: 12px;
        line-height: 1.4;
        margin-bottom: 30px;
    }
    .code-structure-modal-footer {
        padding: 20px;
        border-top: 1px solid #ddd;
        display: flex;
        justify-content: center;
        flex-shrink: 0;
    }
</style>
{% endblock %}

{% block content %}
<div class="evaluation-container">
    <!-- NFR Display Panel -->
    <div class="nfr-panel">
        <div class="panel-header">
            NFRs Display
            <div style="display: flex; gap: 8px;">
                <button class="tutorial-btn" onclick="openCodeStructureModal()" title="View Code Structure">ğŸ“‹ Code Structure</button>
                <button class="tutorial-btn" onclick="openTutorialModal()" title="View Tutorial">ğŸ“– Tutorial</button>
            </div>
        </div>
        <div class="panel-content">
            <div class="batch-info">
                Batch <span id="currentBatch">1</span> of <span id="totalBatches">3</span>
                <button class="copy-nfrs-btn" onclick="copyAllNFRs()" title="Copy all NFRs to clipboard">ğŸ“‹ Copy All NFRs</button>
            </div>
            <div id="nfrList"></div>
        </div>
    </div>
    
    <!-- Form Panel -->
    <div class="form-panel">
        <div class="panel-header">Feedback Form</div>
        <div class="panel-content">
            <form id="batchForm">
                <div id="nfrFormsContainer"></div>
                <button type="submit" class="btn submit-batch-btn" id="submitBatchBtn">Submit All Feedback</button>
            </form>
        </div>
    </div>
    
    <!-- Chatbot Panel -->
    <div class="chatbot-panel">
        <div class="chatbot-header">Chatbot Assistant</div>
        <div class="chatbot-messages" id="chatMessages"></div>
        <div class="chatbot-input">
            <textarea id="chatInput" placeholder="Type your message... (Press Enter to send, Shift+Enter for new line)" rows="2" onkeydown="if(event.key==='Enter' && !event.shiftKey) { event.preventDefault(); sendMessage(); }"></textarea>
            <button class="btn" onclick="sendMessage()">Send</button>
        </div>
    </div>
</div>

<!-- Code Structure Modal -->
<div id="codeStructureModal" class="code-structure-modal">
    <div class="code-structure-modal-overlay" onclick="closeCodeStructureModal()"></div>
    <div class="code-structure-modal-content">
        <div class="code-structure-modal-header">
            <h2>iTrust Code Structure</h2>
            <button class="code-structure-modal-close" onclick="closeCodeStructureModal()">&times;</button>
        </div>
        <div class="code-structure-modal-body">
            <div class="code-structure-section">
                <p style="margin-bottom: 20px; line-height: 1.8;">
                    iTrust is an educational Electronic Health Record (EHR) system developed at NC State University for teaching software engineering. It's designed to handle patient medical records while maintaining HIPAA privacy standards. The system has been continuously developed since 2005, with undergraduate students adding features each semester.
                </p>
                
                <h3>Who Uses iTrust?</h3>
                <p style="margin-bottom: 15px;">The system supports 8 different roles:</p>
                <ol style="margin-left: 20px; line-height: 2; margin-bottom: 30px;">
                    <li><strong>Patient</strong> - Views own medical records, office visits, takes satisfaction surveys</li>
                    <li><strong>LHCP (Licensed Health Care Professional)</strong> - Documents office visits, prescribes medications</li>
                    <li><strong>DLHCP (Designated LHCP)</strong> - Trusted provider with full record access</li>
                    <li><strong>Administrator</strong> - Manages user accounts</li>
                    <li><strong>Emergency Responder</strong> - Limited emergency access</li>
                    <li><strong>UAP (Unlicensed Authorized Personnel)</strong> - Data entry staff</li>
                    <li><strong>Personal Representative</strong> - Legal guardian/proxy</li>
                    <li><strong>Public Health Agent</strong> - Views aggregated epidemiological data</li>
                </ol>
                
                <p style="margin-bottom: 20px; line-height: 1.8;">
                    The system follows a <strong>strict Model-View-Controller (MVC) pattern</strong> with clear separation of concerns across three layers.
                </p>
                
                <h3>Architectural Pattern: Model-View-Controller (MVC)</h3>
                <pre>â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                         CLIENT BROWSER                        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                             â”‚ HTTP Request
                             â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    VIEW LAYER (JSPs)                         â”‚
â”‚  Location: WebRoot/auth/*.jsp                                â”‚
â”‚  - User interface (HTML, JavaScript)                         â”‚
â”‚  - Form submission                                           â”‚
â”‚  - Display data                                              â”‚
â”‚  - 156 JSP files                                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                             â”‚
                             â”‚ Calls Action classes
                             â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                 CONTROLLER LAYER (Actions)                   â”‚
â”‚  Location: src/main/edu/ncsu/csc/itrust/action/*.java       â”‚
â”‚  - Business logic coordination                               â”‚
â”‚  - Input validation (via Validators)                         â”‚
â”‚  - Transaction logging (HIPAA compliance)                   â”‚
â”‚  - Error handling                                            â”‚
â”‚  - 63+ Action classes                                        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                             â”‚
                             â”‚ Uses DAOs
                             â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                   MODEL LAYER                                â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚ BEANS (Data Containers)                              â”‚   â”‚
â”‚  â”‚ Location: model/old/beans/*.java                     â”‚   â”‚
â”‚  â”‚ - PatientBean, OfficeVisitBean, etc.                 â”‚   â”‚
â”‚  â”‚ - Simple getters/setters                             â”‚   â”‚
â”‚  â”‚ - 31+ Bean classes                                   â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚ DAOs (Database Access Objects)                       â”‚   â”‚
â”‚  â”‚ Location: model/old/dao/mysql/*.java                â”‚   â”‚
â”‚  â”‚ - PatientDAO, OfficeVisitDAO, etc.                    â”‚   â”‚
â”‚  â”‚ - SQL queries (PreparedStatements)                    â”‚   â”‚
â”‚  â”‚ - 24+ DAO classes                                     â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚ DATABASE (MySQL)                                      â”‚   â”‚
â”‚  â”‚ - No foreign keys (handled in application code)      â”‚   â”‚
â”‚  â”‚ - Connection pooling via DAOFactory                  â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜</pre>
                
                <h3>Directory Structure</h3>
                <pre>iTrust/
â”œâ”€â”€ WebRoot/                          # Web application root (deployed as WAR)
â”‚   â”œâ”€â”€ auth/                         # Protected pages (role-based)
â”‚   â”‚   â”œâ”€â”€ hcp/                     # Healthcare Provider only
â”‚   â”‚   â”œâ”€â”€ hcp-uap/                 # HCP and UAP shared
â”‚   â”‚   â”œâ”€â”€ patient/                 # Patient only
â”‚   â”‚   â”œâ”€â”€ admin/                   # Administrator only
â”‚   â”‚   â”œâ”€â”€ er/                      # Emergency Responder only
â”‚   â”‚   â”œâ”€â”€ pha/                     # Public Health Agent only
â”‚   â”‚   â””â”€â”€ staff/                   # All staff (HCP, UAP, Admin, LT)
â”‚   â”œâ”€â”€ errors/                      # Error pages (403, 404, 503)
â”‚   â”œâ”€â”€ util/                        # Utility JSPs
â”‚   â”œâ”€â”€ css/                         # Stylesheets
â”‚   â”œâ”€â”€ js/                          # JavaScript files
â”‚   â”œâ”€â”€ image/                       # Images
â”‚   â”œâ”€â”€ login.jsp                    # Login page
â”‚   â”œâ”€â”€ global.jsp                   # Global initialization (DAO, session)
â”‚   â”œâ”€â”€ header.jsp                   # Common header
â”‚   â”œâ”€â”€ footer.jsp                   # Common footer
â”‚   â””â”€â”€ WEB-INF/
â”‚       â”œâ”€â”€ web.xml                  # Servlet configuration, security constraints
â”‚       â”œâ”€â”€ tags.tld                 # Custom tag library
â”‚       â””â”€â”€ lib/                     # JAR dependencies
â”‚
â”œâ”€â”€ src/main/
â”‚   â””â”€â”€ edu/ncsu/csc/itrust/
â”‚       â”œâ”€â”€ action/                  # CONTROLLER LAYER
â”‚       â”‚   â”œâ”€â”€ AddPatientAction.java
â”‚       â”‚   â”œâ”€â”€ EditPatientAction.java
â”‚       â”‚   â”œâ”€â”€ ViewMyRecordsAction.java
â”‚       â”‚   â””â”€â”€ ... (63+ action classes)
â”‚       â”‚
â”‚       â”œâ”€â”€ model/                   # MODEL LAYER
â”‚       â”‚   â”œâ”€â”€ old/
â”‚       â”‚   â”‚   â”œâ”€â”€ beans/           # Data containers
â”‚       â”‚   â”‚   â”‚   â”œâ”€â”€ PatientBean.java
â”‚       â”‚   â”‚   â”‚   â”œâ”€â”€ OfficeVisitBean.java
â”‚       â”‚   â”‚   â”‚   â””â”€â”€ ... (31+ bean classes)
â”‚       â”‚   â”‚   â”‚
â”‚       â”‚   â”‚   â”œâ”€â”€ dao/            # Database access
â”‚       â”‚   â”‚   â”‚   â”œâ”€â”€ DAOFactory.java      # Singleton factory
â”‚       â”‚   â”‚   â”‚   â””â”€â”€ mysql/
â”‚       â”‚   â”‚   â”‚       â”œâ”€â”€ PatientDAO.java
â”‚       â”‚   â”‚   â”‚       â”œâ”€â”€ OfficeVisitDAO.java
â”‚       â”‚   â”‚   â”‚       â””â”€â”€ ... (24+ DAO classes)
â”‚       â”‚   â”‚   â”‚
â”‚       â”‚   â”‚   â””â”€â”€ validate/       # Input validation
â”‚       â”‚   â”‚       â”œâ”€â”€ AddPatientValidator.java
â”‚       â”‚   â”‚       â””â”€â”€ ... (validator classes)
â”‚       â”‚   â”‚
â”‚       â”‚   â””â”€â”€ [newer models]      # Some newer features use different structure
â”‚       â”‚
â”‚       â”œâ”€â”€ logger/                  # Transaction logging (HIPAA)
â”‚       â”‚   â””â”€â”€ TransactionLogger.java
â”‚       â”‚
â”‚       â”œâ”€â”€ server/                 # Servlets
â”‚       â”‚   â”œâ”€â”€ PatientSearchServlet.java
â”‚       â”‚   â””â”€â”€ ...
â”‚       â”‚
â”‚       â””â”€â”€ exception/              # Custom exceptions
â”‚           â”œâ”€â”€ FormValidationException.java
â”‚           â””â”€â”€ ITrustException.java
â”‚
â”œâ”€â”€ src/test/java/                  # Test code
â”‚   â””â”€â”€ edu/ncsu/csc/itrust/
â”‚       â”œâ”€â”€ unit/                   # Unit tests (JUnit)
â”‚       â””â”€â”€ selenium/               # Integration tests
â”‚
â”œâ”€â”€ sql/                            # Database scripts
â”‚   â”œâ”€â”€ createTables.sql            # Schema definition
â”‚   â””â”€â”€ data/                       # Test data
â”‚
â””â”€â”€ pom.xml                         # Maven configuration</pre>
            </div>
        </div>
        <div class="code-structure-modal-footer">
            <button class="btn" onclick="closeCodeStructureModal()">Close</button>
        </div>
    </div>
</div>

<script>
let currentBatch = {{ batch }};
let nfrs = [];
let batchData = null;
let uuid = null;
let submittedNfrs = new Set();

// Load UUID and chat history on page load
window.addEventListener('load', () => {
    // Check if should redirect
    if (redirectToCorrectPage()) return;
    
    // Get UUID from localStorage
    uuid = localStorage.getItem('chatbot_uuid');
    if (!uuid) {
        // No UUID, redirect to consent
        window.location.href = '/';
        return;
    }
    
    // Validate and load chat history
    fetch('/api/get_or_create_uuid', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({uuid: uuid})
    })
    .then(r => r.json())
    .then(data => {
        uuid = data.uuid;
        localStorage.setItem('chatbot_uuid', uuid);
        setCurrentProgress(PROGRESS_STEPS.EVALUATION, {batch: currentBatch});
        loadChatHistory();
        loadNFRs();
    });
    
    // Load progress from localStorage
    loadProgress();
});

function loadNFRs() {
    fetch(`/api/get_requirements?batch=${currentBatch}&uuid=${uuid}`)
        .then(r => r.json())
        .then(data => {
            batchData = data;
            nfrs = data.nfrs;
            document.getElementById('currentBatch').textContent = data.batch;
            document.getElementById('totalBatches').textContent = data.total_batches;
            displayNFRs();
            displayForms();
        });
}

function displayNFRs() {
    const container = document.getElementById('nfrList');
    container.innerHTML = nfrs.map(nfr => `
        <div class="nfr-item">
            <h4>NFR ${nfr.id}: ${nfr.title}</h4>
            <p>${nfr.description}</p>
        </div>
    `).join('');
}

function copyAllNFRs() {
    // Format all NFRs as text
    const nfrText = nfrs.map(nfr => {
        return `NFR ${nfr.id}: ${nfr.title}\n${nfr.description}`;
    }).join('\n\n');
    
    // Copy to clipboard
    navigator.clipboard.writeText(nfrText).then(() => {
        // Show feedback
        const btn = document.querySelector('.copy-nfrs-btn');
        const originalText = btn.textContent;
        btn.textContent = 'âœ“ Copied!';
        btn.style.background = '#28a745';
        setTimeout(() => {
            btn.textContent = originalText;
            btn.style.background = '#007bff';
        }, 2000);
    }).catch(err => {
        console.error('Failed to copy:', err);
        alert('Failed to copy. Please select and copy manually.');
    });
}

function displayForms() {
    const container = document.getElementById('nfrFormsContainer');
    container.innerHTML = nfrs.map(nfr => `
        <div class="nfr-form-section" id="nfr-form-${nfr.id}">
            <h4>NFR ${nfr.id}: ${nfr.title}</h4>
            
            <div class="form-group">
                <label>Question 1: Do you agree with the chatbot's satisfaction level assessment?</label>
                <div class="radio-group">
                    <label><input type="radio" name="q1_${nfr.id}" value="Agree" required> Agree</label>
                    <label><input type="radio" name="q1_${nfr.id}" value="Partially agree"> Partially agree</label>
                    <label><input type="radio" name="q1_${nfr.id}" value="Partially disagree"> Partially disagree</label>
                    <label><input type="radio" name="q1_${nfr.id}" value="Disagree"> Disagree</label>
                </div>
                <div class="form-group" id="q1_assessment_${nfr.id}" style="display: none; margin-top: 10px;">
                    <label>Provide your own assessment:</label>
                    <select name="q1_own_assessment_${nfr.id}" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                        <option value="">Select...</option>
                        <option value="Satisfied">Satisfied</option>
                        <option value="Weakly Satisfied">Weakly Satisfied</option>
                        <option value="Weakly Denied">Weakly Denied</option>
                        <option value="Denied">Denied</option>
                        <option value="NA">NA</option>
                    </select>
                </div>
            </div>
            
            <div class="form-group">
                <label>Question 2: Do you agree with the chatbot's reasoning?</label>
                <div class="radio-group">
                    <label><input type="radio" name="q2_${nfr.id}" value="Agree" required> Agree</label>
                    <label><input type="radio" name="q2_${nfr.id}" value="Partially agree"> Partially agree</label>
                    <label><input type="radio" name="q2_${nfr.id}" value="Partially disagree"> Partially disagree</label>
                    <label><input type="radio" name="q2_${nfr.id}" value="Disagree"> Disagree</label>
                </div>
                <div class="form-group" id="q2_assessment_${nfr.id}" style="display: none; margin-top: 10px;">
                    <label>Provide your own assessment:</label>
                    <textarea name="q2_own_assessment_${nfr.id}" placeholder="Enter your own assessment..." style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px; min-height: 80px;"></textarea>
                </div>
            </div>
            
            <div class="form-group">
                <label>Question 3: Do you agree with the chatbot's identified code locations?</label>
                <div class="radio-group">
                    <label><input type="radio" name="q3_${nfr.id}" value="Agree" required> Agree</label>
                    <label><input type="radio" name="q3_${nfr.id}" value="Partially agree"> Partially agree</label>
                    <label><input type="radio" name="q3_${nfr.id}" value="Partially disagree"> Partially disagree</label>
                    <label><input type="radio" name="q3_${nfr.id}" value="Disagree"> Disagree</label>
                </div>
                <div class="form-group" id="q3_assessment_${nfr.id}" style="display: none; margin-top: 10px;">
                    <label>Provide your own assessment:</label>
                    <textarea name="q3_own_assessment_${nfr.id}" placeholder="Enter your own assessment..." style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px; min-height: 80px;"></textarea>
                </div>
            </div>
        </div>
    `).join('');
    
    // Add event listeners for disagreement detection
    nfrs.forEach(nfr => {
        const q1Radios = document.querySelectorAll(`input[name="q1_${nfr.id}"]`);
        const q2Radios = document.querySelectorAll(`input[name="q2_${nfr.id}"]`);
        const q3Radios = document.querySelectorAll(`input[name="q3_${nfr.id}"]`);
        
        q1Radios.forEach(radio => {
            radio.addEventListener('change', () => checkDisagreement(nfr.id, 1));
        });
        q2Radios.forEach(radio => {
            radio.addEventListener('change', () => checkDisagreement(nfr.id, 2));
        });
        q3Radios.forEach(radio => {
            radio.addEventListener('change', () => checkDisagreement(nfr.id, 3));
        });
    });
    
    // Mark completed NFRs
    submittedNfrs.forEach(nfrId => {
        const formSection = document.getElementById(`nfr-form-${nfrId}`);
        if (formSection) {
            formSection.classList.add('completed');
        }
    });
}

function checkDisagreement(nfrId, questionNum) {
    const selectedValue = document.querySelector(`input[name="q${questionNum}_${nfrId}"]:checked`)?.value;
    const assessmentDiv = document.getElementById(`q${questionNum}_assessment_${nfrId}`);
    
    if (assessmentDiv) {
        if (selectedValue && selectedValue !== 'Agree') {
            assessmentDiv.style.display = 'block';
            // Make the assessment field required
            if (questionNum === 1) {
                const select = document.querySelector(`select[name="q${questionNum}_own_assessment_${nfrId}"]`);
                if (select) select.required = true;
            } else {
                const textarea = document.querySelector(`textarea[name="q${questionNum}_own_assessment_${nfrId}"]`);
                if (textarea) textarea.required = true;
            }
        } else {
            assessmentDiv.style.display = 'none';
            // Remove required attribute
            if (questionNum === 1) {
                const select = document.querySelector(`select[name="q${questionNum}_own_assessment_${nfrId}"]`);
                if (select) {
                    select.required = false;
                    select.value = '';
                }
            } else {
                const textarea = document.querySelector(`textarea[name="q${questionNum}_own_assessment_${nfrId}"]`);
                if (textarea) {
                    textarea.required = false;
                    textarea.value = '';
                }
            }
        }
    }
}

document.getElementById('batchForm').addEventListener('submit', (e) => {
    e.preventDefault();
    
    // Validate all forms first
    let allValid = true;
    const missingFields = [];
    
    nfrs.forEach(nfr => {
        const q1 = document.querySelector(`input[name="q1_${nfr.id}"]:checked`)?.value;
        const q2 = document.querySelector(`input[name="q2_${nfr.id}"]:checked`)?.value;
        const q3 = document.querySelector(`input[name="q3_${nfr.id}"]:checked`)?.value;
        
        if (!q1) {
            allValid = false;
            missingFields.push(`NFR ${nfr.id}: Question 1`);
        }
        if (!q2) {
            allValid = false;
            missingFields.push(`NFR ${nfr.id}: Question 2`);
        }
        if (!q3) {
            allValid = false;
            missingFields.push(`NFR ${nfr.id}: Question 3`);
        }
        
        // Check if own assessments are required (when not Agree)
        if (q1 && q1 !== 'Agree') {
            const q1Assessment = document.querySelector(`select[name="q1_own_assessment_${nfr.id}"]`)?.value || '';
            if (!q1Assessment) {
                allValid = false;
                missingFields.push(`NFR ${nfr.id}: Your own assessment for Question 1`);
            }
        }
        if (q2 && q2 !== 'Agree') {
            const q2Assessment = document.querySelector(`textarea[name="q2_own_assessment_${nfr.id}"]`)?.value || '';
            if (!q2Assessment.trim()) {
                allValid = false;
                missingFields.push(`NFR ${nfr.id}: Your own assessment for Question 2`);
            }
        }
        if (q3 && q3 !== 'Agree') {
            const q3Assessment = document.querySelector(`textarea[name="q3_own_assessment_${nfr.id}"]`)?.value || '';
            if (!q3Assessment.trim()) {
                allValid = false;
                missingFields.push(`NFR ${nfr.id}: Your own assessment for Question 3`);
            }
        }
    });
    
    if (!allValid) {
        alert('Please fill in all required fields:\n' + missingFields.join('\n'));
        return;
    }
    
    // Collect all form data for all NFRs
    const formDataArray = [];
    
    nfrs.forEach(nfr => {
        const q1 = document.querySelector(`input[name="q1_${nfr.id}"]:checked`).value;
        const q2 = document.querySelector(`input[name="q2_${nfr.id}"]:checked`).value;
        const q3 = document.querySelector(`input[name="q3_${nfr.id}"]:checked`).value;
        
        // Get own assessments (only if not Agree)
        const q1_own_assessment = q1 !== 'Agree' ? (document.querySelector(`select[name="q1_own_assessment_${nfr.id}"]`)?.value || '') : '';
        const q2_own_assessment = q2 !== 'Agree' ? (document.querySelector(`textarea[name="q2_own_assessment_${nfr.id}"]`)?.value || '') : '';
        const q3_own_assessment = q3 !== 'Agree' ? (document.querySelector(`textarea[name="q3_own_assessment_${nfr.id}"]`)?.value || '') : '';
        
        formDataArray.push({
            uuid: uuid,
            nfr_id: nfr.id,
            batch: currentBatch,
            q1_agreement: q1,
            q1_own_assessment: q1_own_assessment,
            q2_agreement: q2,
            q2_own_assessment: q2_own_assessment,
            q3_agreement: q3,
            q3_own_assessment: q3_own_assessment,
            timestamp: new Date().toISOString()
        });
    });
    
    // Disable submit button to prevent double submission
    const submitBtn = document.getElementById('submitBatchBtn');
    submitBtn.disabled = true;
    submitBtn.textContent = 'Submitting...';
    
    // Submit all feedback in one batch request to avoid race conditions
    fetch('/api/submit_batch_feedback', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify(formDataArray)
    })
    .then(response => {
        if (!response.ok) {
            throw new Error('Failed to submit batch feedback');
        }
        return response.json();
    })
    .then(result => {
        console.log(`Successfully submitted ${result.count} NFRs`);
        
        // Mark all as submitted
        nfrs.forEach(nfr => {
            submittedNfrs.add(nfr.id);
            const formSection = document.getElementById(`nfr-form-${nfr.id}`);
            if (formSection) {
                formSection.classList.add('completed');
            }
        });
        
        saveNfrProgress();
        
        // Automatically proceed to next batch or survey
        if (currentBatch < batchData.total_batches) {
            // Go to next batch
            currentBatch++;
            submittedNfrs.clear();
            localStorage.setItem('evaluation_batch', currentBatch.toString());
            localStorage.setItem('submitted_nfrs', JSON.stringify([]));
            setCurrentProgress(PROGRESS_STEPS.EVALUATION, {batch: currentBatch});
            // Reload NFRs for next batch
            loadNFRs();
            // Reset form
            document.getElementById('submitBatchBtn').disabled = false;
            document.getElementById('submitBatchBtn').textContent = 'Submit All Feedback';
            // Scroll to top
            window.scrollTo(0, 0);
        } else {
            // All batches completed - go to survey
            setCurrentProgress(PROGRESS_STEPS.SURVEY);
            window.location.href = '/survey';
        }
    })
    .catch(error => {
        console.error('Error submitting feedback:', error);
        alert('Error submitting feedback. Please try again.');
        submitBtn.disabled = false;
        submitBtn.textContent = 'Submit All Feedback';
    });
});

function nextBatch() {
    if (currentBatch < batchData.total_batches) {
        currentBatch++;
        submittedNfrs.clear();
        document.getElementById('nextBatchBtn').style.display = 'none';
        document.getElementById('submitBatchBtn').style.display = 'block';
        localStorage.setItem('evaluation_batch', currentBatch.toString());
        localStorage.setItem('submitted_nfrs', JSON.stringify([]));
        setCurrentProgress(PROGRESS_STEPS.EVALUATION, {batch: currentBatch});
        loadNFRs();
    } else {
        setCurrentProgress(PROGRESS_STEPS.SURVEY);
        window.location.href = '/survey';
    }
}

function sendMessage() {
    const input = document.getElementById('chatInput');
    const message = input.value.trim();
    if (!message || !uuid) return;
    
    // Display user message
    addMessage('user', message);
    input.value = '';
    
    // Send to chatbot with UUID
    fetch('/api/ask_chatbot', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({uuid: uuid, message: message})
    })
    .then(r => r.json())
    .then(data => {
        addMessage('bot', data.response);
        // Update UUID if returned
        if (data.uuid) {
            uuid = data.uuid;
            localStorage.setItem('chatbot_uuid', uuid);
        }
    });
}

function addMessage(type, content) {
    const messagesDiv = document.getElementById('chatMessages');
    const messageDiv = document.createElement('div');
    messageDiv.className = `message ${type}`;
    
    // Escape HTML to prevent XSS, but preserve line breaks
    const escapedContent = content
        .replace(/&/g, '&amp;')
        .replace(/</g, '&lt;')
        .replace(/>/g, '&gt;')
        .replace(/"/g, '&quot;')
        .replace(/'/g, '&#039;');
    
    messageDiv.innerHTML = `
        <div class="message-content">${escapedContent}</div>
        <div class="message-time">${new Date().toLocaleTimeString()}</div>
    `;
    messagesDiv.appendChild(messageDiv);
    messagesDiv.scrollTop = messagesDiv.scrollHeight;
}

function loadChatHistory() {
    if (!uuid) return;
    fetch('/api/load_chat_history', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({uuid: uuid})
    })
    .then(r => r.json())
    .then(data => {
        // Display chat history
        data.history.forEach(entry => {
            addMessage('user', entry.user_message);
            addMessage('bot', entry.bot_reply);
        });
    });
}

function loadProgress() {
    // Load from localStorage
    const savedBatch = localStorage.getItem('evaluation_batch');
    if (savedBatch) {
        currentBatch = parseInt(savedBatch);
    }
    
    const savedNfrs = localStorage.getItem('submitted_nfrs');
    if (savedNfrs) {
        submittedNfrs = new Set(JSON.parse(savedNfrs));
    }
}

function saveNfrProgress() {
    localStorage.setItem('evaluation_batch', currentBatch.toString());
    localStorage.setItem('submitted_nfrs', JSON.stringify(Array.from(submittedNfrs)));
}

function openCodeStructureModal() {
    const modal = document.getElementById('codeStructureModal');
    if (modal) {
        modal.classList.add('active');
        document.body.style.overflow = 'hidden'; // Prevent background scrolling
    }
}

function closeCodeStructureModal() {
    const modal = document.getElementById('codeStructureModal');
    if (modal) {
        modal.classList.remove('active');
        document.body.style.overflow = ''; // Restore scrolling
    }
}

// Close modal on Escape key
document.addEventListener('keydown', function(e) {
    if (e.key === 'Escape') {
        closeCodeStructureModal();
    }
});
</script>
{% endblock %}
