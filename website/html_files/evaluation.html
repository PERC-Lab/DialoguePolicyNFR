{% extends "base.html" %}

{% block title %}Evaluation{% endblock %}

{% block extra_css %}
<style>
    .evaluation-container {
        display: flex;
        height: calc(100vh - 40px);
        gap: 20px;
        margin: 20px;
    }
    .nfr-panel, .form-panel, .chatbot-panel {
        flex: 1;
        background: white;
        border-radius: 8px;
        box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        display: flex;
        flex-direction: column;
        overflow: hidden;
    }
    .panel-header {
        padding: 15px;
        background: #007bff;
        color: white;
        font-weight: 600;
        border-radius: 8px 8px 0 0;
        display: flex;
        justify-content: space-between;
        align-items: center;
    }
    .panel-content {
        flex: 1;
        padding: 20px;
        overflow-y: auto;
    }
    .batch-info {
        padding: 10px;
        background: #e9ecef;
        border-radius: 4px;
        margin-bottom: 15px;
        text-align: center;
        font-weight: 600;
        display: flex;
        justify-content: space-between;
        align-items: center;
    }
    .copy-nfrs-btn {
        padding: 6px 12px;
        background: #007bff;
        color: white;
        border: none;
        border-radius: 4px;
        cursor: pointer;
        font-size: 12px;
        transition: background 0.3s;
    }
    .copy-nfrs-btn:hover {
        background: #0056b3;
    }
    .nfr-item {
        margin-bottom: 20px;
        padding: 15px;
        background: #f8f9fa;
        border-radius: 4px;
        border-left: 4px solid #007bff;
    }
    .nfr-item h4 {
        margin-bottom: 8px;
        color: #333;
        font-size: 14px;
        font-weight: 600;
    }
    .nfr-item p {
        margin: 0;
        color: #666;
        font-size: 13px;
        line-height: 1.5;
    }
    .nfr-form-section {
        margin-bottom: 30px;
        padding: 15px;
        background: #f8f9fa;
        border-radius: 4px;
        border: 1px solid #ddd;
    }
    .nfr-form-section h4 {
        margin-bottom: 15px;
        color: #333;
        font-size: 14px;
    }
    .form-group {
        margin-bottom: 15px;
    }
    .form-group label {
        display: block;
        margin-bottom: 8px;
        font-weight: 600;
        font-size: 13px;
    }
    .form-group textarea {
        width: 100%;
        padding: 8px;
        border: 1px solid #ddd;
        border-radius: 4px;
        font-size: 13px;
        resize: vertical;
        min-height: 60px;
    }
    .radio-group {
        display: flex;
        gap: 10px;
        flex-wrap: wrap;
        margin-top: 5px;
    }
    .radio-group label {
        display: flex;
        align-items: center;
        font-weight: normal;
        cursor: pointer;
        font-size: 12px;
    }
    .radio-group input[type="radio"] {
        margin-right: 5px;
    }
    .chatbot-header {
        padding: 15px;
        background: #007bff;
        color: white;
        border-radius: 8px 8px 0 0;
        font-weight: 600;
    }
    .chatbot-messages {
        flex: 1;
        padding: 20px;
        overflow-y: auto;
        background: #f8f9fa;
    }
    .message {
        margin-bottom: 15px;
    }
    .message.user {
        text-align: right;
    }
    .message.bot {
        text-align: left;
    }
    .message-content {
        display: inline-block;
        padding: 10px 15px;
        border-radius: 18px;
        max-width: 80%;
    }
    .message.user .message-content {
        background: #007bff;
        color: white;
    }
    .message.bot .message-content {
        background: white;
        color: #333;
        border: 1px solid #ddd;
    }
    .message-time {
        font-size: 11px;
        color: #666;
        margin-top: 5px;
    }
    .chatbot-input {
        padding: 15px;
        border-top: 1px solid #ddd;
        display: flex;
        gap: 10px;
    }
    .chatbot-input input {
        flex: 1;
        padding: 10px;
        border: 1px solid #ddd;
        border-radius: 4px;
    }
    .chatbot-input button {
        padding: 10px 20px;
    }
    .submit-batch-btn {
        margin-top: 20px;
        width: 100%;
        padding: 12px;
        font-size: 16px;
    }
    .nfr-form-section.completed {
        border-color: #28a745;
        background: #d4edda;
    }
    .tutorial-btn {
        padding: 6px 12px;
        background: rgba(255, 255, 255, 0.2);
        color: white;
        border: 1px solid rgba(255, 255, 255, 0.3);
        border-radius: 4px;
        cursor: pointer;
        font-size: 12px;
        transition: background 0.3s;
    }
    .tutorial-btn:hover {
        background: rgba(255, 255, 255, 0.3);
    }
</style>
{% endblock %}

{% block content %}
<div class="evaluation-container">
    <!-- NFR Display Panel -->
    <div class="nfr-panel">
        <div class="panel-header">
            NFRs Display
            <button class="tutorial-btn" onclick="openTutorialModal()" title="View Tutorial">ðŸ“– Tutorial</button>
        </div>
        <div class="panel-content">
            <div class="batch-info">
                Batch <span id="currentBatch">1</span> of <span id="totalBatches">3</span>
                <button class="copy-nfrs-btn" onclick="copyAllNFRs()" title="Copy all NFRs to clipboard">ðŸ“‹ Copy All NFRs</button>
            </div>
            <div id="nfrList"></div>
        </div>
    </div>
    
    <!-- Form Panel -->
    <div class="form-panel">
        <div class="panel-header">Feedback Form</div>
        <div class="panel-content">
            <form id="batchForm">
                <div id="nfrFormsContainer"></div>
                <button type="submit" class="btn submit-batch-btn" id="submitBatchBtn">Submit All Feedback</button>
            </form>
        </div>
    </div>
    
    <!-- Chatbot Panel -->
    <div class="chatbot-panel">
        <div class="chatbot-header">Chatbot Assistant</div>
        <div class="chatbot-messages" id="chatMessages"></div>
        <div class="chatbot-input">
            <input type="text" id="chatInput" placeholder="Type your message..." onkeypress="if(event.key==='Enter') sendMessage()">
            <button class="btn" onclick="sendMessage()">Send</button>
        </div>
    </div>
</div>

<script>
let currentBatch = {{ batch }};
let nfrs = [];
let batchData = null;
let uuid = null;
let submittedNfrs = new Set();

// Load UUID and chat history on page load
window.addEventListener('load', () => {
    // Check if should redirect
    if (redirectToCorrectPage()) return;
    
    // Get UUID from localStorage
    uuid = localStorage.getItem('chatbot_uuid');
    if (!uuid) {
        // No UUID, redirect to consent
        window.location.href = '/';
        return;
    }
    
    // Validate and load chat history
    fetch('/api/get_or_create_uuid', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({uuid: uuid})
    })
    .then(r => r.json())
    .then(data => {
        uuid = data.uuid;
        localStorage.setItem('chatbot_uuid', uuid);
        setCurrentProgress(PROGRESS_STEPS.EVALUATION, {batch: currentBatch});
        loadChatHistory();
        loadNFRs();
    });
    
    // Load progress from localStorage
    loadProgress();
});

function loadNFRs() {
    fetch(`/api/get_requirements?batch=${currentBatch}&uuid=${uuid}`)
        .then(r => r.json())
        .then(data => {
            batchData = data;
            nfrs = data.nfrs;
            document.getElementById('currentBatch').textContent = data.batch;
            document.getElementById('totalBatches').textContent = data.total_batches;
            displayNFRs();
            displayForms();
        });
}

function displayNFRs() {
    const container = document.getElementById('nfrList');
    container.innerHTML = nfrs.map(nfr => `
        <div class="nfr-item">
            <h4>NFR ${nfr.id}: ${nfr.title}</h4>
            <p>${nfr.description}</p>
        </div>
    `).join('');
}

function copyAllNFRs() {
    // Format all NFRs as text
    const nfrText = nfrs.map(nfr => {
        return `NFR ${nfr.id}: ${nfr.title}\n${nfr.description}`;
    }).join('\n\n');
    
    // Copy to clipboard
    navigator.clipboard.writeText(nfrText).then(() => {
        // Show feedback
        const btn = document.querySelector('.copy-nfrs-btn');
        const originalText = btn.textContent;
        btn.textContent = 'âœ“ Copied!';
        btn.style.background = '#28a745';
        setTimeout(() => {
            btn.textContent = originalText;
            btn.style.background = '#007bff';
        }, 2000);
    }).catch(err => {
        console.error('Failed to copy:', err);
        alert('Failed to copy. Please select and copy manually.');
    });
}

function displayForms() {
    const container = document.getElementById('nfrFormsContainer');
    container.innerHTML = nfrs.map(nfr => `
        <div class="nfr-form-section" id="nfr-form-${nfr.id}">
            <h4>NFR ${nfr.id}: ${nfr.title}</h4>
            
            <div class="form-group">
                <label>Question 1: Do you agree with the chatbot's satisfaction level assessment?</label>
                <div class="radio-group">
                    <label><input type="radio" name="q1_${nfr.id}" value="Agree" required> Agree</label>
                    <label><input type="radio" name="q1_${nfr.id}" value="Partially agree"> Partially agree</label>
                    <label><input type="radio" name="q1_${nfr.id}" value="Partially disagree"> Partially disagree</label>
                    <label><input type="radio" name="q1_${nfr.id}" value="Disagree"> Disagree</label>
                </div>
                <div class="form-group" id="q1_assessment_${nfr.id}" style="display: none; margin-top: 10px;">
                    <label>Provide your own assessment:</label>
                    <select name="q1_own_assessment_${nfr.id}" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                        <option value="">Select...</option>
                        <option value="Satisfied">Satisfied</option>
                        <option value="Weakly Satisfied">Weakly Satisfied</option>
                        <option value="Weakly Denied">Weakly Denied</option>
                        <option value="Denied">Denied</option>
                        <option value="NA">NA</option>
                    </select>
                </div>
            </div>
            
            <div class="form-group">
                <label>Question 2: Do you agree with the chatbot's reasoning?</label>
                <div class="radio-group">
                    <label><input type="radio" name="q2_${nfr.id}" value="Agree" required> Agree</label>
                    <label><input type="radio" name="q2_${nfr.id}" value="Partially agree"> Partially agree</label>
                    <label><input type="radio" name="q2_${nfr.id}" value="Partially disagree"> Partially disagree</label>
                    <label><input type="radio" name="q2_${nfr.id}" value="Disagree"> Disagree</label>
                </div>
                <div class="form-group" id="q2_assessment_${nfr.id}" style="display: none; margin-top: 10px;">
                    <label>Provide your own assessment:</label>
                    <textarea name="q2_own_assessment_${nfr.id}" placeholder="Enter your own assessment..." style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px; min-height: 80px;"></textarea>
                </div>
            </div>
            
            <div class="form-group">
                <label>Question 3: Do you agree with the chatbot's identified code locations?</label>
                <div class="radio-group">
                    <label><input type="radio" name="q3_${nfr.id}" value="Agree" required> Agree</label>
                    <label><input type="radio" name="q3_${nfr.id}" value="Partially agree"> Partially agree</label>
                    <label><input type="radio" name="q3_${nfr.id}" value="Partially disagree"> Partially disagree</label>
                    <label><input type="radio" name="q3_${nfr.id}" value="Disagree"> Disagree</label>
                </div>
                <div class="form-group" id="q3_assessment_${nfr.id}" style="display: none; margin-top: 10px;">
                    <label>Provide your own assessment:</label>
                    <textarea name="q3_own_assessment_${nfr.id}" placeholder="Enter your own assessment..." style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px; min-height: 80px;"></textarea>
                </div>
            </div>
        </div>
    `).join('');
    
    // Add event listeners for disagreement detection
    nfrs.forEach(nfr => {
        const q1Radios = document.querySelectorAll(`input[name="q1_${nfr.id}"]`);
        const q2Radios = document.querySelectorAll(`input[name="q2_${nfr.id}"]`);
        const q3Radios = document.querySelectorAll(`input[name="q3_${nfr.id}"]`);
        
        q1Radios.forEach(radio => {
            radio.addEventListener('change', () => checkDisagreement(nfr.id, 1));
        });
        q2Radios.forEach(radio => {
            radio.addEventListener('change', () => checkDisagreement(nfr.id, 2));
        });
        q3Radios.forEach(radio => {
            radio.addEventListener('change', () => checkDisagreement(nfr.id, 3));
        });
    });
    
    // Mark completed NFRs
    submittedNfrs.forEach(nfrId => {
        const formSection = document.getElementById(`nfr-form-${nfrId}`);
        if (formSection) {
            formSection.classList.add('completed');
        }
    });
}

function checkDisagreement(nfrId, questionNum) {
    const selectedValue = document.querySelector(`input[name="q${questionNum}_${nfrId}"]:checked`)?.value;
    const assessmentDiv = document.getElementById(`q${questionNum}_assessment_${nfrId}`);
    
    if (assessmentDiv) {
        if (selectedValue && selectedValue !== 'Agree') {
            assessmentDiv.style.display = 'block';
            // Make the assessment field required
            if (questionNum === 1) {
                const select = document.querySelector(`select[name="q${questionNum}_own_assessment_${nfrId}"]`);
                if (select) select.required = true;
            } else {
                const textarea = document.querySelector(`textarea[name="q${questionNum}_own_assessment_${nfrId}"]`);
                if (textarea) textarea.required = true;
            }
        } else {
            assessmentDiv.style.display = 'none';
            // Remove required attribute
            if (questionNum === 1) {
                const select = document.querySelector(`select[name="q${questionNum}_own_assessment_${nfrId}"]`);
                if (select) {
                    select.required = false;
                    select.value = '';
                }
            } else {
                const textarea = document.querySelector(`textarea[name="q${questionNum}_own_assessment_${nfrId}"]`);
                if (textarea) {
                    textarea.required = false;
                    textarea.value = '';
                }
            }
        }
    }
}

document.getElementById('batchForm').addEventListener('submit', (e) => {
    e.preventDefault();
    
    // Validate all forms first
    let allValid = true;
    const missingFields = [];
    
    nfrs.forEach(nfr => {
        const q1 = document.querySelector(`input[name="q1_${nfr.id}"]:checked`)?.value;
        const q2 = document.querySelector(`input[name="q2_${nfr.id}"]:checked`)?.value;
        const q3 = document.querySelector(`input[name="q3_${nfr.id}"]:checked`)?.value;
        
        if (!q1) {
            allValid = false;
            missingFields.push(`NFR ${nfr.id}: Question 1`);
        }
        if (!q2) {
            allValid = false;
            missingFields.push(`NFR ${nfr.id}: Question 2`);
        }
        if (!q3) {
            allValid = false;
            missingFields.push(`NFR ${nfr.id}: Question 3`);
        }
        
        // Check if own assessments are required (when not Agree)
        if (q1 && q1 !== 'Agree') {
            const q1Assessment = document.querySelector(`select[name="q1_own_assessment_${nfr.id}"]`)?.value || '';
            if (!q1Assessment) {
                allValid = false;
                missingFields.push(`NFR ${nfr.id}: Your own assessment for Question 1`);
            }
        }
        if (q2 && q2 !== 'Agree') {
            const q2Assessment = document.querySelector(`textarea[name="q2_own_assessment_${nfr.id}"]`)?.value || '';
            if (!q2Assessment.trim()) {
                allValid = false;
                missingFields.push(`NFR ${nfr.id}: Your own assessment for Question 2`);
            }
        }
        if (q3 && q3 !== 'Agree') {
            const q3Assessment = document.querySelector(`textarea[name="q3_own_assessment_${nfr.id}"]`)?.value || '';
            if (!q3Assessment.trim()) {
                allValid = false;
                missingFields.push(`NFR ${nfr.id}: Your own assessment for Question 3`);
            }
        }
    });
    
    if (!allValid) {
        alert('Please fill in all required fields:\n' + missingFields.join('\n'));
        return;
    }
    
    // Collect all form data for all NFRs
    const formDataArray = [];
    
    nfrs.forEach(nfr => {
        const q1 = document.querySelector(`input[name="q1_${nfr.id}"]:checked`).value;
        const q2 = document.querySelector(`input[name="q2_${nfr.id}"]:checked`).value;
        const q3 = document.querySelector(`input[name="q3_${nfr.id}"]:checked`).value;
        
        // Get own assessments (only if not Agree)
        const q1_own_assessment = q1 !== 'Agree' ? (document.querySelector(`select[name="q1_own_assessment_${nfr.id}"]`)?.value || '') : '';
        const q2_own_assessment = q2 !== 'Agree' ? (document.querySelector(`textarea[name="q2_own_assessment_${nfr.id}"]`)?.value || '') : '';
        const q3_own_assessment = q3 !== 'Agree' ? (document.querySelector(`textarea[name="q3_own_assessment_${nfr.id}"]`)?.value || '') : '';
        
        formDataArray.push({
            uuid: uuid,
            nfr_id: nfr.id,
            batch: currentBatch,
            q1_agreement: q1,
            q1_own_assessment: q1_own_assessment,
            q2_agreement: q2,
            q2_own_assessment: q2_own_assessment,
            q3_agreement: q3,
            q3_own_assessment: q3_own_assessment,
            timestamp: new Date().toISOString()
        });
    });
    
    // Disable submit button to prevent double submission
    const submitBtn = document.getElementById('submitBatchBtn');
    submitBtn.disabled = true;
    submitBtn.textContent = 'Submitting...';
    
    // Submit all feedback in one batch request to avoid race conditions
    fetch('/api/submit_batch_feedback', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify(formDataArray)
    })
    .then(response => {
        if (!response.ok) {
            throw new Error('Failed to submit batch feedback');
        }
        return response.json();
    })
    .then(result => {
        console.log(`Successfully submitted ${result.count} NFRs`);
        
        // Mark all as submitted
        nfrs.forEach(nfr => {
            submittedNfrs.add(nfr.id);
            const formSection = document.getElementById(`nfr-form-${nfr.id}`);
            if (formSection) {
                formSection.classList.add('completed');
            }
        });
        
        saveNfrProgress();
        
        // Automatically proceed to next batch or survey
        if (currentBatch < batchData.total_batches) {
            // Go to next batch
            currentBatch++;
            submittedNfrs.clear();
            localStorage.setItem('evaluation_batch', currentBatch.toString());
            localStorage.setItem('submitted_nfrs', JSON.stringify([]));
            setCurrentProgress(PROGRESS_STEPS.EVALUATION, {batch: currentBatch});
            // Reload NFRs for next batch
            loadNFRs();
            // Reset form
            document.getElementById('submitBatchBtn').disabled = false;
            document.getElementById('submitBatchBtn').textContent = 'Submit All Feedback';
            // Scroll to top
            window.scrollTo(0, 0);
        } else {
            // All batches completed - go to survey
            setCurrentProgress(PROGRESS_STEPS.SURVEY);
            window.location.href = '/survey';
        }
    })
    .catch(error => {
        console.error('Error submitting feedback:', error);
        alert('Error submitting feedback. Please try again.');
        submitBtn.disabled = false;
        submitBtn.textContent = 'Submit All Feedback';
    });
});

function nextBatch() {
    if (currentBatch < batchData.total_batches) {
        currentBatch++;
        submittedNfrs.clear();
        document.getElementById('nextBatchBtn').style.display = 'none';
        document.getElementById('submitBatchBtn').style.display = 'block';
        localStorage.setItem('evaluation_batch', currentBatch.toString());
        localStorage.setItem('submitted_nfrs', JSON.stringify([]));
        setCurrentProgress(PROGRESS_STEPS.EVALUATION, {batch: currentBatch});
        loadNFRs();
    } else {
        setCurrentProgress(PROGRESS_STEPS.SURVEY);
        window.location.href = '/survey';
    }
}

function sendMessage() {
    const input = document.getElementById('chatInput');
    const message = input.value.trim();
    if (!message || !uuid) return;
    
    // Display user message
    addMessage('user', message);
    input.value = '';
    
    // Send to chatbot with UUID
    fetch('/api/ask_chatbot', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({uuid: uuid, message: message})
    })
    .then(r => r.json())
    .then(data => {
        addMessage('bot', data.response);
        // Update UUID if returned
        if (data.uuid) {
            uuid = data.uuid;
            localStorage.setItem('chatbot_uuid', uuid);
        }
    });
}

function addMessage(type, content) {
    const messagesDiv = document.getElementById('chatMessages');
    const messageDiv = document.createElement('div');
    messageDiv.className = `message ${type}`;
    messageDiv.innerHTML = `
        <div class="message-content">${content}</div>
        <div class="message-time">${new Date().toLocaleTimeString()}</div>
    `;
    messagesDiv.appendChild(messageDiv);
    messagesDiv.scrollTop = messagesDiv.scrollHeight;
}

function loadChatHistory() {
    if (!uuid) return;
    fetch('/api/load_chat_history', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({uuid: uuid})
    })
    .then(r => r.json())
    .then(data => {
        // Display chat history
        data.history.forEach(entry => {
            addMessage('user', entry.user_message);
            addMessage('bot', entry.bot_reply);
        });
    });
}

function loadProgress() {
    // Load from localStorage
    const savedBatch = localStorage.getItem('evaluation_batch');
    if (savedBatch) {
        currentBatch = parseInt(savedBatch);
    }
    
    const savedNfrs = localStorage.getItem('submitted_nfrs');
    if (savedNfrs) {
        submittedNfrs = new Set(JSON.parse(savedNfrs));
    }
}

function saveNfrProgress() {
    localStorage.setItem('evaluation_batch', currentBatch.toString());
    localStorage.setItem('submitted_nfrs', JSON.stringify(Array.from(submittedNfrs)));
}
</script>
{% endblock %}
